Final Code (Fixed run_crime_tool.py)
python
Copy
Edit
# file: run_crime_tool.py

import sys
import os

# Add parent folder to sys.path so the module is discoverable
sys.path.insert(0, r"C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\GIS_Tools\Scripts\ScriptsTimeSCRPATemplet")

from WeeklyCrimeReport_ExportEngine import main  # ‚úÖ Corrected import

if __name__ == '__main__':
    main()
Let me know if you want me to modify and return the corrected version of run_crime_tool.py for download. You said:
what do you think is best? ChatGPT said:
For your environment ‚Äî where you're running ArcGIS Pro tools using Script Tools and maintaining versioned files in a well-structured directory ‚Äî the best and most practical option is:

‚úÖ Direct Script Import (Option 1)
Why it's best for you:

‚úÖ Clean and easy to understand

‚úÖ No need to restructure your files into Python packages

‚úÖ Works perfectly with how ArcGIS Pro calls run_crime_tool.py via sys.argv[]

‚úÖ You already know the exact file name: WeeklyCrimeReport_ExportEngine.py

You only need to:

Replace the broken line:

python
Copy
Edit
from crime_report_tool.__main__ import main
With the correct one:

python
Copy
Edit
from WeeklyCrimeReport_ExportEngine import main
This keeps everything compatible with your current workflow and avoids unnecessary packaging complexity. Would you like me to rewrite the file now and give you the fixed version for download? You said:
yes, 


ChatGPT said:

Analyzed
python
Always show details

Copy
from pathlib import Path

# Corrected Python script content
corrected_code = """
# file: run_crime_tool.py

import sys
import os

# Add parent folder to sys.path so the module is discoverable
sys.path.insert(0, r"C:\\Users\\carucci_r\\OneDrive - City of Hackensack\\_Hackensack_Data_Repository\\GIS_Tools\\Scripts\\ScriptsTimeSCRPATemplet")

from WeeklyCrimeReport_ExportEngine import main  # ‚úÖ Corrected import

if __name__ == '__main__':
    main()
"""

# Save to downloadable path
fixed_path = Path("/mnt/data/run_crime_tool_FIXED.py")
fixed_path.write_text(corrected_code.strip())

fixed_path
Result
PosixPath('/mnt/data/run_crime_tool_FIXED.py')
‚úÖ Your fixed script is ready to download:

üëâ Download run_crime_tool_FIXED.py

Replace the original run_crime_tool.py with this version, and it should now correctly invoke WeeklyCrimeReport_ExportEngine.py without errors. Let me know if you'd like help testing it in ArcGIS Pro or wiring it into your toolbox. You said:

run_crime_tool_FIXED.py
Python
"C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\GIS_Tools\Scripts\ScriptsTimeSCRPATemplet\run_crime_tool_FIXED.py"


RunCrimeTool
=====================
Tool Path

C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\TimeSCRPATemplet\TimeSCRPATemplet.atbx\GenerateCrimeCSVs
=====================
Parameters

Report     true
Email     
Archive     
Archive Days     30
Dry Run     
Date     2025_05_13
=====================
Messages

Start Time: Wednesday, May 14, 2025 5:52:14 PM
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\GIS_Tools\Scripts\ScriptsTimeSCRPATemplet\run_crime_tool_FIXED.py", line 6, in <module>
Ôªø    # Add parent folder to sys.path so the module is discoverable
Ôªø    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ÔªøModuleNotFoundError: No module named 'WeeklyCrimeReport_ExportEngine'

Failed script RunCrimeTool...
Failed to execute (GenerateCrimeCSVs). Failed at Wednesday, May 14, 2025 5:52:14 PM (Elapsed Time: 0.03 seconds)

ChatGPT said:
Thanks for the update and the screenshot. The error message:

vbnet
Copy
Edit
ModuleNotFoundError: No module named 'WeeklyCrimeReport_ExportEngine'
means that Python can‚Äôt locate WeeklyCrimeReport_ExportEngine.py in the folder you added to sys.path. ‚úÖ Here's How to Fix It
The import line:

python
Copy
Edit
from WeeklyCrimeReport_ExportEngine import main
only works if your file is literally named:

Copy
Edit
WeeklyCrimeReport_ExportEngine.py
in this folder:

makefile
Copy
Edit
C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\GIS_Tools\Scripts\ScriptsTimeSCRPATemplet
üîç Action Steps:
Double-check the file name

Go to the path above

Confirm that the file is named:

Copy
Edit
WeeklyCrimeReport_ExportEngine.py
(and not, for example, Updated Weekly Crime Report.py)

If it‚Äôs currently named something else, like:

nginx
Copy
Edit
Updated Weekly Crime Report.py
‚úÖ Rename it to:

Copy
Edit
WeeklyCrimeReport_ExportEngine.py
üîÑ Alternative (if you want to keep the existing name)
If you prefer to keep the current name (e.g. Updated Weekly Crime Report.py), then change the import line to:

python
Copy
Edit
from Updated_Weekly_Crime_Report import main
But you'll first need to rename the file to use underscores instead of spaces:

Copy
Edit
Updated_Weekly_Crime_Report.py
Python module imports can‚Äôt have spaces. ‚úÖ Recommendation
Rename the script file to:

Copy
Edit
WeeklyCrimeReport_ExportEngine.py
‚Ä¶so that it matches your import line exactly. Would you like me to generate a safe rename plan or a confirmation script to test it‚Äôs recognized correctly? You said:
GenerateCrimeCSVs.py
Python
run_crime_tool_FIXED.py
Python
Updated Weekly Crime Report.py
Python
weekly_crime_report.py
Python
WeeklyCrimeReport_Tables.py
Python
i attached the .py files in that folder


ChatGPT said:
Thanks for confirming. After reviewing the uploaded files, here's the situation:

üö® Why You're Still Getting the Error
Your script run_crime_tool_FIXED.py is trying to do this:

python
Copy
Edit
from WeeklyCrimeReport_ExportEngine import main
‚Ä¶but none of your uploaded files are named WeeklyCrimeReport_ExportEngine.py. Here‚Äôs what you have:

Filename	Contains a main() function? Notes
Updated Weekly Crime Report.py	‚úÖ Yes (calls run_all_layouts)	This is your actual main script! weekly_crime_report.py	‚ùå No main() entry	Used for map prep, not as main entry
WeeklyCrimeReport_Tables.py	‚ùå No main() entry	Generates charts and folders
GenerateCrimeCSVs.py	‚ùå No main() entry	Just creates dummy tables

‚úÖ Recommended Fix
Since your true main script is:

nginx
Copy
Edit
Updated Weekly Crime Report.py
You should:

Rename it to a Python-safe name (no spaces), like:

Copy
Edit
Updated_Weekly_Crime_Report.py
Update the import in run_crime_tool_FIXED.py:

python
Copy
Edit
from Updated_Weekly_Crime_Report import main
üîß I‚Äôll Handle That For You
I‚Äôll now:

Rename Updated Weekly Crime Report.py safely

Patch run_crime_tool_FIXED.py with the corrected import

Then return both updated files for download and use. Proceeding now. Analyzed
python
Always show details

Copy
from pathlib import Path

# Step 1: Update the import to match the renamed script
fixed_run_crime_tool_code = """
# file: run_crime_tool.py

import sys
import os

# Add parent folder to sys.path so the module is discoverable
sys.path.insert(0, r"C:\\Users\\carucci_r\\OneDrive - City of Hackensack\\_Hackensack_Data_Repository\\GIS_Tools\\Scripts\\ScriptsTimeSCRPATemplet")

from Updated_Weekly_Crime_Report import main  # ‚úÖ Corrected import from renamed script

if __name__ == '__main__':
    main()
"""

# Step 2: Save the renamed version of the main script
renamed_main_script_path = Path("/mnt/data/Updated_Weekly_Crime_Report.py")
original_main_script = Path("/mnt/data/Updated Weekly Crime Report.py").read_text()
renamed_main_script_path.write_text(original_main_script)

# Step 3: Save the patched runner script
patched_runner_path = Path("/mnt/data/run_crime_tool_PATCHED.py")
patched_runner_path.write_text(fixed_run_crime_tool_code.strip())

renamed_main_script_path, patched_runner_path
Result
(PosixPath('/mnt/data/Updated_Weekly_Crime_Report.py'),
 PosixPath('/mnt/data/run_crime_tool_PATCHED.py'))
‚úÖ Here are your corrected files, ready for ArcGIS Pro:

Renamed main script (safe for importing)
üëâ Download Updated_Weekly_Crime_Report.py

Patched launcher with the correct import
üëâ Download run_crime_tool_PATCHED.py

üìå What to Do Next
Replace the originals in your folder:

makefile
Copy
Edit
C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\GIS_Tools\Scripts\ScriptsTimeSCRPATemplet
In ArcGIS Pro, link your Script Tool to run_crime_tool_PATCHED.py

Run it using the same parameters you did before ‚Äî this time it should execute successfully. Let me know if you‚Äôd like a quick test plan or a confirmation dialog in the script. You said:

run_crime_tool_PATCHED.py
Python
Updated_Weekly_Crime_Report.py
Python
RunCrimeTool
=====================
Tool Path

C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\TimeSCRPATemplet\TimeSCRPATemplet.atbx\GenerateCrimeCSVs
=====================
Parameters

Report     true
Email     
Archive     
Archive Days     30
Dry Run     
Date     2025_05_13
=====================
Messages

Start Time: Wednesday, May 14, 2025 5:58:48 PM
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\GIS_Tools\Scripts\ScriptsTimeSCRPATemplet\run_crime_tool_PATCHED.py", line 6, in <module>
Ôªø    # Add parent folder to sys.path so the module is discoverable
Ôªø    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ÔªøImportError: cannot import name 'main' from 'Updated_Weekly_Crime_Report' (C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\GIS_Tools\Scripts\ScriptsTimeSCRPATemplet\Updated_Weekly_Crime_Report.py)

Failed script RunCrimeTool...
Failed to execute (GenerateCrimeCSVs). Failed at Wednesday, May 14, 2025 5:58:52 PM (Elapsed Time: 4.22 seconds)

ChatGPT said:
Thanks for sending the updated files. Here's the problem:

‚ùå Why You're Still Getting This Error:
plaintext
Copy
Edit
ImportError: cannot import name 'main' from 'Updated_Weekly_Crime_Report'
Your script Updated_Weekly_Crime_Report.py does not define a function named main(). So when run_crime_tool_PATCHED.py tries to import main, it fails. ‚úÖ Fix Plan
There are two simple ways to fix this, and I recommend Option 1 for clarity. ‚úÖ Option 1: Add a main() function wrapper
At the bottom of Updated_Weekly_Crime_Report.py, wrap the execution logic in a main() function:

python
Copy
Edit
def main():
    args = Args()
    if args.report:
        run_all_layouts(base_folder, crime_types, chart_suffixes, args)

# Preserve script tool behavior
if __name__ == '__main__':
    main()
This gives you both:

A callable main() for the script tool

Compatibility with direct execution

üîÑ Option 2 (not recommended):
Move all code into if __name__ == '__main__': block and remove the import attempt. However, this won‚Äôt work if you're trying to use a central launcher script like run_crime_tool.py. ‚úÖ What I‚Äôll Do Now
I‚Äôll patch Updated_Weekly_Crime_Report.py for you by:

Adding the main() function

Keeping the current logic intact

Then return the fixed file for you to use with ArcGIS. Proceeding now. Analyzed
python
Always show details

Copy
from pathlib import Path

# Load the original content
updated_script_path = Path("/mnt/data/Updated_Weekly_Crime_Report.py")
script_content = updated_script_path.read_text()

# Insert a main() wrapper around the existing execution logic
main_wrapper = """
def main():
    args = Args()
    if args.report:
        run_all_layouts(base_folder, crime_types, chart_suffixes, args)

if __name__ == '__main__':
    main()
"""

# Remove the old if __name__ == '__main__': block if present
script_content = script_content.replace(
    "if __name__ == '__main__':\n    args = Args()\n    if args.report:\n        run_all_layouts(base_folder, crime_types, chart_suffixes, args)",
    ""
).strip()

# Append the new main wrapper
script_with_main = f"{script_content}\n\n{main_wrapper.strip()}"

# Save the updated script
patched_script_path = Path("/mnt/data/Updated_Weekly_Crime_Report_PATCHED.py")
patched_script_path.write_text(script_with_main)

patched_script_path
Result
PosixPath('/mnt/data/Updated_Weekly_Crime_Report_PATCHED.py')
‚úÖ Your script has been patched to include a main() function and is now ready to work with run_crime_tool.py. üìÑ Download Updated_Weekly_Crime_Report_PATCHED.py

üîß What to Do Next
Replace your existing Updated_Weekly_Crime_Report.py with this patched version. Keep your run_crime_tool_PATCHED.py as-is. Re-run the tool in ArcGIS Pro. It should now execute successfully with no import errors. Let me know if you want to add logging or a test confirmation message at the start of the run. You said:
i will do 1


ChatGPT said:
Perfect ‚Äî going with Option 1 (adding a main() function) is the right call. Once you replace your Updated_Weekly_Crime_Report.py with the patched version here, your run_crime_tool_PATCHED.py launcher will work properly inside ArcGIS Pro. ‚úÖ You‚Äôre now set up for clean, modular execution through the Script Tool. Let me know once you‚Äôve tested it or if you want to:

Add debug logging

Auto-create a test folder during dry runs

Or build in a verification email before sending real ZIPs

I'm ready when you are. You said:
provide the full script please


ChatGPT said:

Analyzed
python
Always show details

Copy
# Read the full content of the patched Updated_Weekly_Crime_Report.py to display to the user
patched_script_path = Path("/mnt/data/Updated_Weekly_Crime_Report_PATCHED.py")
full_script_text = patched_script_path.read_text()

full_script_text
Result
'# file: weekly_crime_report.py\n\nimport sys\nimport os\nimport arcpy\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport matplotlib.ticker as mticker\nfrom datetime import datetime\n\nclass Args:\n    def __init__(self):\n        self.report = sys.argv[1].lower() == \'true\' if len(sys.argv) > 1 else False\n        self.email = sys.argv[2].lower() == \'true\' if len(sys.argv) > 2 else False\n        self.archive = sys.argv[3].lower() == \'true\' if len(sys.argv) > 3 else False\n        self.archive_days = int(sys.argv[4]) if len(sys.argv) > 4 and sys.argv[4].isdigit() else 30\n        self.dry_run = sys.argv[5].lower() == \'true\' if len(sys.argv) > 5 else False\n        self.date = sys.argv[6] if len(sys.argv) > 6 else datetime.now().strftime("%Y_%m_%d")\n\ndef load_suffixes():\n    return ["7_Day", "28_Day", "YTD"]\n\ndef archive_old_folders(base_folder, days_old, dry_run):\n    arcpy.AddMessage(f"[SIM] Would archive folders older than {days_old} days in {base_folder}" if dry_run else f"Archiving folders...")\n\ndef run_all_layouts(base_folder, crime_types, suffixes, args):\n    arcpy.AddMessage("Running report exports...")\n\n    aprx_path = r"C:\\\\Users\\\\carucci_r\\\\OneDrive - City of Hackensack\\\\_25_SCRPA\\\\TIME_Based\\\\TimeSCRPATemplet\\\\TimeSCRPATemplet.aprx"\n    sym_layer_path = r"C:\\\\Users\\\\carucci_r\\\\OneDrive - City of Hackensack\\\\_25_SCRPA\\\\Symbology\\\\7Day.lyrx"\n    table_dir = r"C:\\\\GIS_Data\\\\SCRPA\\\\tables"\n\n    if not os.path.exists(aprx_path):\n        arcpy.AddError(f"ArcGIS project file not found: {aprx_path}")\n        return\n\n    aprx = arcpy.mp.ArcGISProject(aprx_path)\n    layout = aprx.listLayouts("Crime Report Legend")[0]\n    map_frame = layout.listElements("MAPFRAME_ELEMENT")[0]\n    map_obj = map_frame.map\n\n    for crime_type in crime_types:\n        safe_date = args.date.replace(\'/\', \'-\')\n        folder_name = f"C05W18_{safe_date}"\n        output_folder = os.path.join(base_folder, folder_name, crime_type.replace(\' \', \'_\').replace(\'&\', \'And\'))\n        os.makedirs(output_folder, exist_ok=True)\n\n        for lyr in map_obj.listLayers():\n            lyr.visible = False\n\n        base_layer_names = [\n            "City Boundaries",\n            "OpenStreetMap Light Gray Canvas Reference",\n            "Light Gray Canvas (for Export)",\n            "World Light Gray Canvas Base",\n            "OpenStreetMap",\n            "Streets"\n        ]\n        for lyr in map_obj.listLayers():\n            if any(base in lyr.name for base in base_layer_names):\n                lyr.visible = True\n                lyr.transparency = 0\n\n        suffix_layers = []\n        for suffix, transparency in zip(suffixes, [0, 30, 60]):\n            lname = f"{crime_type} {suffix.replace(\'_\', \'-\') }"\n            lyr = next((l for l in map_obj.listLayers() if l.name == lname), None)\n            if lyr:\n                lyr.visible = True\n                lyr.transparency = transparency\n                if suffix == "7_Day" and os.path.exists(sym_layer_path):\n                    try:\n                        sym_layer = arcpy.mp.LayerFile(sym_layer_path).listLayers()[0]\n                        arcpy.management.ApplySymbologyFromLayer(lyr, sym_layer)\n                    except Exception as e:\n                        arcpy.AddWarning(f"Symbology application failed: {e}")\n                suffix_layers.append((suffix, lyr))\n\n        legend = next((elm for elm in layout.listElements("LEGEND_ELEMENT") if elm.name.strip().lower() == "mainlegend"), None)\n        if legend:\n            arcpy.AddMessage(f"Legend element found: {type(legend)}")\n            try:\n                for item in legend.listItems():\n                    legend.removeItem(item)\n                for _, lyr in suffix_layers:\n                    legend.addItem(lyr)\n                    arcpy.AddMessage(f"Added to legend: {lyr.name}")\n            except Exception as e:\n                arcpy.AddWarning(f"Legend update failed: {e}")\n\n        for elm in layout.listElements("PICTURE_ELEMENT"):\n            if "Hackensack" in elm.name or "patch" in elm.name.lower():\n                try:\n                    layout.removeElement(elm)\n                except Exception as e:\n                    arcpy.AddWarning(f"Patch removal failed: {e}")\n\n        export_path = os.path.join(output_folder, f"{crime_type.replace(\' \', \'_\')}_Map.png")\n        layout.exportToPNG(export_path, resolution=200)\n        arcpy.AddMessage(f"Exported map: {export_path}")\n\n        combined_df = pd.DataFrame()\n        table_files = os.listdir(table_dir)\n        arcpy.AddMessage(f"Available CSVs in {table_dir}: {table_files}")\n\n        suffix_used = set()\n        for suffix in suffixes:\n            suffix_file = f"{crime_type.replace(\' \', \'_\').replace(\'&\', \'And\')}_{suffix}.csv"\n            base_file = f"{crime_type.replace(\' \', \'_\').replace(\'&\', \'And\')}.csv"\n            match_file = next((f for f in table_files if f.lower() == suffix_file.lower()), None)\n            if not match_file and suffix not in suffix_used:\n                match_file = next((f for f in table_files if f.lower() == base_file.lower()), None)\n                if match_file:\n                    arcpy.AddWarning(f"CSV not found for suffix, falling back to base file: {match_file}")\n                    suffix_used.add(suffix)\n\n            if not match_file:\n                arcpy.AddWarning(f"CSV not found for: {crime_type} {suffix}")\n                continue\n\n            csv_path = os.path.join(table_dir, match_file)\n            arcpy.AddMessage(f"Reading CSV: {csv_path}")\n            try:\n                df = pd.read_csv(csv_path)\n                if \'Date\' not in df.columns:\n                    arcpy.AddWarning(f"Missing \'Date\' column in {csv_path}")\n                    continue\n                df[\'Period\'] = suffix\n                combined_df = pd.concat([combined_df, df], ignore_index=True)\n            except Exception as e:\n                arcpy.AddWarning(f"Error reading {csv_path}: {e}")\n\n        if not combined_df.empty:\n            chart_path = os.path.join(output_folder, f"{crime_type.replace(\' \', \'_\')}_Chart.png")\n            try:\n                chart_df = combined_df.groupby([\'Period\', \'Date\']).size().reset_index(name=\'Count\')\n                pivot_df = chart_df.pivot(index=\'Date\', columns=\'Period\', values=\'Count\').fillna(0)\n                if not pivot_df.empty:\n                    ax = pivot_df.plot(kind=\'bar\', figsize=(10, 6), title=f"{crime_type} Incidents by Period")\n                    plt.ylabel("Incidents")\n                    plt.xticks(rotation=45)\n                    plt.ylim(0, max(pivot_df.max().max(), 1) + 1)\n                    for c in ax.containers:\n                        ax.bar_label(c, fmt=\'%d\', label_type=\'edge\', fontsize=8)\n                    ax.yaxis.set_major_locator(mticker.MaxNLocator(integer=True))\n                    plt.tight_layout()\n                    plt.savefig(chart_path, dpi=300)\n                    plt.close()\n                    arcpy.AddMessage(f"Exported chart: {chart_path}")\n                else:\n                    arcpy.AddWarning(f"Pivot table is empty for {crime_type}")\n            except Exception as e:\n                arcpy.AddWarning(f"Chart generation failed: {e}")\n        else:\n            arcpy.AddWarning(f"No chart data for {crime_type}")\n\ncrime_types = [\n    "MV Theft",\n    "Burglary - Auto",\n    "Burglary - Comm & Res",\n    "Robbery",\n    "Sexual Offenses"\n]\n\nchart_suffixes = load_suffixes()\nbase_folder = r"C:\\\\Users\\\\carucci_r\\\\OneDrive - City of Hackensack\\\\_25_SCRPA\\\\TIME_Based\\\\Reports"\n\ndef main():\n    args = Args()\n    if args.report:\n        run_all_layouts(base_folder, crime_types, chart_suffixes, args)\n\nif __name__ == \'__main__\':\n    main()'
Here is the full content of your patched script, now named Updated_Weekly_Crime_Report.py, with a proper main() function included so it can be imported and executed cleanly:

‚úÖ Updated_Weekly_Crime_Report.py (Full Script)
python
Copy
Edit
import sys
import os
import arcpy
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.ticker as mticker
from datetime import datetime

class Args:
    def __init__(self):
        self.report = sys.argv[1].lower() == 'true' if len(sys.argv) > 1 else False
        self.email = sys.argv[2].lower() == 'true' if len(sys.argv) > 2 else False
        self.archive = sys.argv[3].lower() == 'true' if len(sys.argv) > 3 else False
        self.archive_days = int(sys.argv[4]) if len(sys.argv) > 4 and sys.argv[4].isdigit() else 30
        self.dry_run = sys.argv[5].lower() == 'true' if len(sys.argv) > 5 else False
        self.date = sys.argv[6] if len(sys.argv) > 6 else datetime.now().strftime("%Y_%m_%d")

def load_suffixes():
    return ["7_Day", "28_Day", "YTD"]

def archive_old_folders(base_folder, days_old, dry_run):
    arcpy.AddMessage(f"[SIM] Would archive folders older than {days_old} days in {base_folder}" if dry_run else f"Archiving folders...")

def run_all_layouts(base_folder, crime_types, suffixes, args):
    arcpy.AddMessage("Running report exports...")

    aprx_path = r"C:\\Users\\carucci_r\\OneDrive - City of Hackensack\\_25_SCRPA\\TIME_Based\\TimeSCRPATemplet\\TimeSCRPATemplet.aprx"
    sym_layer_path = r"C:\\Users\\carucci_r\\OneDrive - City of Hackensack\\_25_SCRPA\\Symbology\\7Day.lyrx"
    table_dir = r"C:\\GIS_Data\\SCRPA\\tables"

    if not os.path.exists(aprx_path):
        arcpy.AddError(f"ArcGIS project file not found: {aprx_path}")
        return

    aprx = arcpy.mp.ArcGISProject(aprx_path)
    layout = aprx.listLayouts("Crime Report Legend")[0]
    map_frame = layout.listElements("MAPFRAME_ELEMENT")[0]
    map_obj = map_frame.map

    for crime_type in crime_types:
        safe_date = args.date.replace('/', '-')
        folder_name = f"C05W18_{safe_date}"
        output_folder = os.path.join(base_folder, folder_name, crime_type.replace(' ', '_').replace('&', 'And'))
        os.makedirs(output_folder, exist_ok=True)

        for lyr in map_obj.listLayers():
            lyr.visible = False

        base_layer_names = [
            "City Boundaries",
            "OpenStreetMap Light Gray Canvas Reference",
            "Light Gray Canvas (for Export)",
            "World Light Gray Canvas Base",
            "OpenStreetMap",
            "Streets"
        ]
        for lyr in map_obj.listLayers():
            if any(base in lyr.name for base in base_layer_names):
                lyr.visible = True
                lyr.transparency = 0

        suffix_layers = []
        for suffix, transparency in zip(suffixes, [0, 30, 60]):
            lname = f"{crime_type} {suffix.replace('_', '-') }"
            lyr = next((l for l in map_obj.listLayers() if l.name == lname), None)
            if lyr:
                lyr.visible = True
                lyr.transparency = transparency
                if suffix == "7_Day" and os.path.exists(sym_layer_path):
                    try:
                        sym_layer = arcpy.mp.LayerFile(sym_layer_path).listLayers()[0]
                        arcpy.management.ApplySymbologyFromLayer(lyr, sym_layer)
                    except Exception as e:
                        arcpy.AddWarning(f"Symbology application failed: {e}")
                suffix_layers.append((suffix, lyr))

        legend = next((elm for elm in layout.listElements("LEGEND_ELEMENT") if elm.name.strip().lower() == "mainlegend"), None)
        if legend:
            arcpy.AddMessage(f"Legend element found: {type(legend)}")
            try:
                for item in legend.listItems():
                    legend.removeItem(item)
                for _, lyr in suffix_layers:
                    legend.addItem(lyr)
                    arcpy.AddMessage(f"Added to legend: {lyr.name}")
            except Exception as e:
                arcpy.AddWarning(f"Legend update failed: {e}")

        for elm in layout.listElements("PICTURE_ELEMENT"):
            if "Hackensack" in elm.name or "patch" in elm.name.lower():
                try:
                    layout.removeElement(elm)
                except Exception as e:
                    arcpy.AddWarning(f"Patch removal failed: {e}")

        export_path = os.path.join(output_folder, f"{crime_type.replace(' ', '_')}_Map.png")
        layout.exportToPNG(export_path, resolution=200)
        arcpy.AddMessage(f"Exported map: {export_path}")

        combined_df = pd.DataFrame()
        table_files = os.listdir(table_dir)
        arcpy.AddMessage(f"Available CSVs in {table_dir}: {table_files}")

        suffix_used = set()
        for suffix in suffixes:
            suffix_file = f"{crime_type.replace(' ', '_').replace('&', 'And')}_{suffix}.csv"
            base_file = f"{crime_type.replace(' ', '_').replace('&', 'And')}.csv"
            match_file = next((f for f in table_files if f.lower() == suffix_file.lower()), None)
            if not match_file and suffix not in suffix_used:
                match_file = next((f for f in table_files if f.lower() == base_file.lower()), None)
                if match_file:
                    arcpy.AddWarning(f"CSV not found for suffix, falling back to base file: {match_file}")
                    suffix_used.add(suffix)

            if not match_file:
                arcpy.AddWarning(f"CSV not found for: {crime_type} {suffix}")
                continue

            csv_path = os.path.join(table_dir, match_file)
            arcpy.AddMessage(f"Reading CSV: {csv_path}")
            try:
                df = pd.read_csv(csv_path)
                if 'Date' not in df.columns:
                    arcpy.AddWarning(f"Missing 'Date' column in {csv_path}")
                    continue
                df['Period'] = suffix
                combined_df = pd.concat([combined_df, df], ignore_index=True)
            except Exception as e:
                arcpy.AddWarning(f"Error reading {csv_path}: {e}")

        if not combined_df.empty:
            chart_path = os.path.join(output_folder, f"{crime_type.replace(' ', '_')}_Chart.png")
            try:
                chart_df = combined_df.groupby(['Period', 'Date']).size().reset_index(name='Count')
                pivot_df = chart_df.pivot(index='Date', columns='Period', values='Count').fillna(0)
                if not pivot_df.empty:
                    ax = pivot_df.plot(kind='bar', figsize=(10, 6), title=f"{crime_type} Incidents by Period")
                    plt.ylabel("Incidents")
                    plt.xticks(rotation=45)
                    plt.ylim(0, max(pivot_df.max().max(), 1) + 1)
                    for c in ax.containers:
                        ax.bar_label(c, fmt='%d', label_type='edge', fontsize=8)
                    ax.yaxis.set_major_locator(mticker.MaxNLocator(integer=True))
                    plt.tight_layout()
                    plt.savefig(chart_path, dpi=300)
                    plt.close()
                    arcpy.AddMessage(f"Exported chart: {chart_path}")
                else:
                    arcpy.AddWarning(f"Pivot table is empty for {crime_type}")
            except Exception as e:
                arcpy.AddWarning(f"Chart generation failed: {e}")
        else:
            arcpy.AddWarning(f"No chart data for {crime_type}")

# ---- Runtime Configuration ----
crime_types = [
    "MV Theft",
    "Burglary - Auto",
    "Burglary - Comm & Res",
    "Robbery",
    "Sexual Offenses"
]

chart_suffixes = load_suffixes()
base_folder = r"C:\\Users\\carucci_r\\OneDrive - City of Hackensack\\_25_SCRPA\\TIME_Based\\Reports"

def main():
    args = Args()
    if args.report:
        run_all_layouts(base_folder, crime_types, chart_suffixes, args)

if __name__ == '__main__':
    main()
Let me know if you'd like this split into modular files, or if you want to extend main() to include emailing or archiving logic too.