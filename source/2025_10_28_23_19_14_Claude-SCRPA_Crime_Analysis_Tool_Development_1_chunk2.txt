try:
        elements_to_remove = []
        for elm in layout.listElements("PICTURE_ELEMENT"):
            if "hackensack" in elm.name.lower() or "patch" in elm.name.lower():
                elements_to_remove.append(elm)
                
        if not elements_to_remove:
            arcpy.AddMessage("üí° No patch elements found to remove")
            return
                
        for elm in elements_to_remove:
            try:
                layout.removeElement(elm)
                arcpy.AddMessage(f"üßπ Removed patch element: {elm.name}")
            except Exception as e:
                arcpy.AddWarning(f"‚ùå Failed to remove patch element {elm.name}: {str(e)}")
                
        arcpy.AddMessage(f"‚úÖ Patch cleanup completed: {len(elements_to_remove)} elements processed")
                
    except Exception as e:
        arcpy.AddWarning(f"‚ùå Patch cleanup failed: {str(e)}")

def export_map_to_png_enhanced(layout, crime_type, output_folder, filename_prefix):
    """Enhanced map export with better error handling and verification"""
    try:
        # Ensure output folder exists
        if not os.path.exists(output_folder):
            os.makedirs(output_folder)
            arcpy.AddMessage(f"üìÅ Created output folder: {output_folder}")
        else:
            arcpy.AddMessage(f"üìÅ Using existing output folder: {output_folder}")
            
        # Clean up old map files with standardized pattern
        cleanup_pattern = os.path.join(output_folder, f"{filename_prefix}_Map*.png")
        old_files = glob.glob(cleanup_pattern)
        
        removed_count = 0
        for file_path in old_files:
            try:
                os.remove(file_path)
                arcpy.AddMessage(f"üßπ Deleted old export: {os.path.basename(file_path)}")
                removed_count += 1
            except Exception as e:
                arcpy.AddWarning(f"‚ö†Ô∏è Could not delete old map file {file_path}: {str(e)}")
        
        if removed_count > 0:
            arcpy.AddMessage(f"‚úÖ Cleaned up {removed_count} old map files")

        # Export new map with standardized filename
        export_filename = f"{filename_prefix}_Map.png"
        export_path = os.path.join(output_folder, export_filename)
        
        # Export with enhanced error handling
        arcpy.AddMessage(f"üñºÔ∏è Exporting map to: {export_path}")
        
        try:
            # Try enhanced export first
            layout.exportToPNG(export_path, resolution=200, world_file=False, 
                             color_mode='24-BIT_TRUE_COLOR', rle_compression=False)
            arcpy.AddMessage("‚úÖ Map exported successfully (enhanced method)")
        except Exception as e:
            arcpy.AddWarning(f"‚ö†Ô∏è Enhanced export failed: {e}")
            # Fallback to basic export
            try:
                layout.exportToPNG(export_path, resolution=200)
                arcpy.AddMessage("‚úÖ Map exported successfully (basic method)")
            except Exception as e2:
                arcpy.AddError(f"‚ùå Both export methods failed: {e2}")
                return False
        
        # Verify export was successful
        if os.path.exists(export_path):
            file_size = os.path.getsize(export_path)
            arcpy.AddMessage(f"‚úÖ Map export verified: {export_path} ({file_size:,} bytes)")
            
            # Additional verification - check if file is not empty/corrupted
            if file_size < 1000:  # Less than 1KB is suspicious
                arcpy.AddWarning(f"‚ö†Ô∏è Export file suspiciously small: {file_size} bytes")
            
            return True
        else:
            arcpy.AddError(f"‚ùå Export file was not created: {export_path}")
            return False
        
    except Exception as e:
        arcpy.AddError(f"‚ùå Export failed: {str(e)}")
        logging.error(f"Map export failed for {crime_type}: {e}", exc_info=True)
        return False

def create_placeholder_image(crime_type, output_path):
    """Create a placeholder image for crime types with 0 incidents in 7-day period.""" try:
        # Image dimensions (converted from inches at 200 DPI)
        # 5.74" x 4.44" at 200 DPI = 1148 x 888 pixels
        width = 1148
        height = 888
        
        # Create white background
        img = Image.new('RGB', (width, height), 'white')
        draw = ImageDraw.Draw(img)
        
        # Try to use a system font, fallback to default
        try:
            # Try common Windows fonts
            title_font = ImageFont.truetype("arial.ttf", 48)
            subtitle_font = ImageFont.truetype("arial.ttf", 36)
            text_font = ImageFont.truetype("arial.ttf", 32)
        except:
            try:
                title_font = ImageFont.truetype("calibri.ttf", 48)
                subtitle_font = ImageFont.truetype("calibri.ttf", 36)
                text_font = ImageFont.truetype("calibri.ttf", 32)
            except:
                # Fallback to default font
                title_font = ImageFont.load_default()
                subtitle_font = ImageFont.load_default()
                text_font = ImageFont.load_default()
        
        # Calculate text positions (centered)
        title_text = crime_type
        subtitle_text = "Weekly Incident Report"
        main_text = "0 incidents recorded (7-day period)"
        
        # Get text bounding boxes for centering
        title_bbox = draw.textbbox((0, 0), title_text, font=title_font)
        subtitle_bbox = draw.textbbox((0, 0), subtitle_text, font=subtitle_font)
        main_bbox = draw.textbbox((0, 0), main_text, font=text_font)
        
        title_width = title_bbox[2] - title_bbox[0]
        subtitle_width = subtitle_bbox[2] - subtitle_bbox[0]
        main_width = main_bbox[2] - main_bbox[0]
        
        # Center positions
        title_x = (width - title_width) // 2
        subtitle_x = (width - subtitle_width) // 2
        main_x = (width - main_width) // 2
        
        # Vertical positions
        title_y = height // 4
        subtitle_y = height // 2 - 50
        main_y = height // 2 + 20
        
        # Draw text
        draw.text((title_x, title_y), title_text, fill='black', font=title_font)
        draw.text((subtitle_x, subtitle_y), subtitle_text, fill='#666666', font=subtitle_font)
        draw.text((main_x, main_y), main_text, fill='#333333', font=text_font)
        
        # Add a subtle border
        border_color = '#CCCCCC'
        draw.rectangle([10, 10, width-10, height-10], outline=border_color, width=2)
        
        # Save the image
        img.save(output_path, 'PNG', dpi=(200, 200))
        arcpy.AddMessage(f"‚úÖ Created placeholder image: {output_path}")
        
        return True
        
    except Exception as e:
        arcpy.AddError(f"‚ùå Error creating placeholder image: {e}")
        return False

def export_maps(crime_type, output_folder, args):
    """
    Enhanced map export showing ONLY 7-Day incidents with fixed basemap rendering. Creates placeholder images for crime types with 0 7-day incidents.
    """ aprx = None
    
    try:
        # Validate configuration first
        if not validate_config():
            return False
            
        logging.info(f"üó∫Ô∏è Starting enhanced map export for: {crime_type}")
        
        # Get date from args
        try:
            date_str = args[6]  # YYYY_MM_DD format
            target_date = datetime.strptime(date_str, "%Y_%m_%d").date()
        except (IndexError, TypeError, ValueError):
            target_date = date.today()
            date_str = target_date.strftime("%Y_%m_%d")
            
        # Create crime-specific output folder using Excel naming
        crime_output_folder = get_crime_type_folder(crime_type, date_str)
        os.makedirs(crime_output_folder, exist_ok=True)
        arcpy.AddMessage(f"üìÅ Crime-specific folder: {crime_output_folder}")
        
        # Get standardized filename prefix
        filename_prefix = get_standardized_filename(crime_type)
        
        # Load ArcGIS Pro project
        aprx = arcpy.mp.ArcGISProject(APR_PATH)
        arcpy.AddMessage(f"‚úÖ Loaded ArcGIS Pro project: {APR_PATH}")
        
        # Get layout and map objects
        layouts = aprx.listLayouts("Crime Report Legend")
        if not layouts:
            arcpy.AddError("‚ùå Layout 'Crime Report Legend' not found")
            available_layouts = [layout.name for layout in aprx.listLayouts()]
            arcpy.AddError(f"Available layouts: {available_layouts}")
            return False
            
        layout = layouts[0]
        arcpy.AddMessage(f"‚úÖ Found layout: {layout.name}")
        
        # Get map frame
        map_frames = layout.listElements("MAPFRAME_ELEMENT")
        if not map_frames:
            arcpy.AddError("‚ùå No map frame elements found in layout")
            return False
            
        map_frame = map_frames[0]
        map_obj = map_frame.map
        arcpy.AddMessage(f"‚úÖ Found map: {map_obj.name}")

        # Store original layer states for restoration
        original_states = {}
        for lyr in map_obj.listLayers():
            original_states[lyr.name] = {
                'visible': lyr.visible,
                'transparency': lyr.transparency
            }

        # Hide all layers initially
        layer_count = 0
        for lyr in map_obj.listLayers():
            lyr.visible = False
            layer_count += 1
        arcpy.AddMessage(f"üîÑ Hidden {layer_count} layers initially")

        # Show base layers with enhanced function
        base_success = show_base_layers_enhanced(map_obj)
        if not base_success:
            arcpy.AddWarning("‚ö†Ô∏è No base layers enabled - maps may appear blank")

        # Get Excel-based 7-day period dates
        start_date, end_date = get_7day_period_dates(target_date)
        
        if not start_date or not end_date:
            arcpy.AddError(f"‚ùå Could not determine Excel 7-day period for {target_date}")
            return False
            
        arcpy.AddMessage(f"üìÖ Excel 7-Day period: {start_date} to {end_date}")

        # Find and configure ONLY the 7-Day layer
        layer_name = f"{crime_type} 7-Day"
        target_layer = None
        
        for lyr in map_obj.listLayers():
            if lyr.name == layer_name:
                target_layer = lyr
                break
        
        if not target_layer:
            arcpy.AddWarning(f"‚ùå 7-Day layer not found: {layer_name}")
            # Create placeholder and return
            export_filename = f"{filename_prefix}_Map.png"
            export_path = os.path.join(crime_output_folder, export_filename)
            success = create_placeholder_image(crime_type, export_path)
            return success
        
        # Show and configure the 7-Day layer
        target_layer.visible = True
        target_layer.transparency = 0  # Full opacity for single layer
        arcpy.AddMessage(f"‚úÖ Configured 7-Day layer: {target_layer.name}")

        # Apply definition query using Excel dates
        filter_sql = build_sql_filter_7day_excel(crime_type, start_date, end_date)
        
        if filter_sql:
            arcpy.AddMessage(f"üîé Excel-based SQL for 7-Day {layer_name}: {filter_sql}")
            target_layer.definitionQuery = filter_sql
            arcpy.AddMessage(f"‚úÖ Applied Excel-based query to {target_layer.name}")
            
            # Log feature count
            try:
                feature_count = int(arcpy.GetCount_management(target_layer).getOutput(0))
                arcpy.AddMessage(f"üìä 7-Day features: {feature_count}")
                
                # If no features, create placeholder instead of map
                if feature_count == 0:
                    arcpy.AddMessage(f"üìã No 7-day incidents for {crime_type}, creating placeholder")
                    export_filename = f"{filename_prefix}_Map.png"
                    export_path = os.path.join(crime_output_folder, export_filename)
                    success = create_placeholder_image(crime_type, export_path)
                    
                    # Restore original layer states
                    for lyr in map_obj.listLayers():
                        if lyr.name in original_states:
                            lyr.visible = original_states[lyr.name]['visible']
                            lyr.transparency = original_states[lyr.name]['transparency']
                    arcpy.AddMessage("‚úÖ Restored original layer states")
                    return success
                    
            except Exception as e:
                arcpy.AddWarning(f"‚ö†Ô∏è Could not get feature count: {e}")
        else:
            arcpy.AddWarning(f"‚ö†Ô∏è Could not build SQL filter for {crime_type}")

        # Apply enhanced symbology
        apply_enhanced_symbology(target_layer, crime_type)

        # Calculate and apply optimal extent
        calculate_optimal_map_extent(target_layer, map_frame, map_obj)

        # Update legend to show only 7-Day layer
        update_legend_visibility_7day(layout, map_obj, target_layer)

        # Clean up patch elements
        cleanup_patch_elements(layout)

        # Export the map with enhanced function
        success = export_map_to_png_enhanced(layout, crime_type, crime_output_folder, filename_prefix)
        
        # Restore original layer states
        for lyr in map_obj.listLayers():
            if lyr.name in original_states:
                lyr.visible = original_states[lyr.name]['visible']
                lyr.transparency = original_states[lyr.name]['transparency']
        arcpy.AddMessage("‚úÖ Restored original layer states")
        
        if success:
            arcpy.AddMessage(f"‚úÖ Map export completed successfully for {crime_type}")
        
        return success
        
    except Exception as e:
        arcpy.AddError(f"‚ùå Critical error in export_maps: {str(e)}")
        logging.error(f"Critical error in export_maps for {crime_type}: {e}", exc_info=True)
        return False
    finally:
        # Clean up ArcGIS Pro project
        if aprx:
            try:
                del aprx
                arcpy.AddMessage("üßπ Cleaned up ArcGIS Pro project reference")
            except Exception as e:
                arcpy.AddWarning(f"‚ö†Ô∏è Could not clean up project reference: {e}")
````

**Complete main.py - Drop-in Ready with PowerPoint Fix**

````python
# üïí 2025-01-27-22-40-00
# SCRPA_Police_Analysis/main_complete_fixed
# Author: R. A. Carucci
# Purpose: Complete drop-in replacement for main.py with PowerPoint slide creation and enhanced error handling

import sys
import logging
import time
import os
import glob
import shutil
from pathlib import Path
from
````



## Prompt:
6/24/2025, 3:53:34 AM

Continue



## Response:
6/24/2025, 3:55:23 AM



**Complete main.py - Drop-in Ready with PowerPoint Fix** ‚àô Version 2

````python
# üïí 2025-01-27-22-40-00
# SCRPA_Police_Analysis/main_complete_fixed
# Author: R. A. Carucci
# Purpose: Complete drop-in replacement for main.py with PowerPoint slide creation and enhanced error handling

import sys
import logging
import time
import os
import glob
import shutil
from pathlib import Path
from datetime import datetime as dt_datetime, date as dt_date
import arcpy

# Initialize ArcGIS Pro license
try:
    # Check available license types
    if arcpy.CheckProduct("ArcInfo") == "Available":
        arcpy.CheckOutExtension("ArcInfo")
        logging.info("‚úÖ ArcInfo license initialized")
    elif arcpy.CheckProduct("ArcEditor") == "Available":
        arcpy.CheckOutExtension("ArcEditor")
        logging.info("‚úÖ ArcEditor license initialized")
    elif arcpy.CheckProduct("ArcView") == "Available":
        arcpy.CheckOutExtension("ArcView")
        logging.info("‚úÖ ArcView license initialized")
    else:
        logging.error("‚ùå No ArcGIS license available")
        sys.exit(1)
except Exception as e:
    logging.error(f"‚ùå License initialization failed: {e}")
    sys.exit(1)

print("OK DateTime imported correctly as dt_datetime and dt_date")

def parse_date_string(date_str):
    """Parse date string from YYYY_MM_DD format"""
    try:
        return dt_datetime.strptime(date_str, "%Y_%m_%d").date()
    except ValueError:
        raise ValueError(f"Invalid date format: {date_str}. Expected YYYY_MM_DD")

def debug_mode(target_date_str=None):
    """Enhanced debug mode with Excel patching and comprehensive testing"""
    if target_date_str is None:
        target_date_str = "2025_01_27"
    
    print(f"\nDEBUG MODE ACTIVE")
    print("=" * 60)
    print(f"Target Date: {target_date_str}")
    
    try:
        target_date = dt_datetime.strptime(target_date_str, "%Y_%m_%d").date()
        
        from config import (
            get_excel_report_name, get_correct_folder_name, get_output_folder,
            get_7day_period_dates, validate_all_paths, CRIME_FOLDER_MAPPING, REPORT_BASE_DIR
        )
        
        print(f"\nEXCEL INTEGRATION TEST")
        print("-" * 40)
        
        report_name = get_excel_report_name(target_date)
        print(f"Excel Report Name: {report_name}")
        
        folder_name = get_correct_folder_name(target_date)
        print(f"Folder Name: {folder_name}")
        
        start_date, end_date = get_7day_period_dates(target_date)
        print(f"7-Day Period: {start_date} to {end_date}")
        
        output_path = get_output_folder(target_date_str)
        print(f"Output Path: {output_path}")
        
        print(f"\nPATH VALIDATION")
        print("-" * 40)
        paths_valid = validate_all_paths()
        
        print(f"\nCRIME TYPES")
        print("-" * 40)
        crime_types = list(CRIME_FOLDER_MAPPING.keys())
        print(f"Count: {len(crime_types)}")
        for i, crime_type in enumerate(crime_types, 1):
            print(f"  {i}.