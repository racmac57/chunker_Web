current_cycle = cycle_df[cycle_df['Is_Due'] == True].iloc[0]

# Extract dates and report name
seven_day_start = pd.to_datetime(current_cycle['7_Day_Start']).strftime('%Y-%m-%d')
seven_day_end = pd.to_datetime(current_cycle['7_Day_End']).strftime('%Y-%m-%d')
twenty_eight_day_start = pd.to_datetime(current_cycle['28_Day_Start']).strftime('%Y-%m-%d')
twenty_eight_day_end = pd.to_datetime(current_cycle['28_Day_End']).strftime('%Y-%m-%d')
ytd_start = '2024-12-31'
report_name = current_cycle['Report_Name']
report_due_date = pd.to_datetime(current_cycle['Report_Due_Date']).strftime('%Y_%m_%d')

# Create output folder
report_folder = os.path.join(export_root, f"{report_name}_{report_due_date}")
os.makedirs(report_folder, exist_ok=True)

# Keywords per crime type
keywords_by_crime = {
    "Burglary - Auto": ['auto'],
    "Burglary - Comm & Res": ['residence', 'commercial'],
    "Robbery": ['robbery'],
    "Sexual Offenses": ['sexual'],
    "MV Theft": ['motor vehicle theft']
}

# SQL builders
def build_sql(start_date, end_date, keywords):
    calltype_clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return (
        f"calldate >= date '{start_date}' AND calldate <= date '{end_date}' "
        f"AND disposition LIKE '%report%' AND ({calltype_clause})"
    )

def build_sql_ytd(keywords):
    calltype_clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return (
        f"calldate >= date '{ytd_start}' "
        f"AND disposition LIKE '%report%' AND ({calltype_clause})"
    )

# Construct and apply queries
layer_query_mapping = {}
for crime, keywords in keywords_by_crime.items():
    layer_query_mapping[f"{crime} 7-Day"] = build_sql(seven_day_start, seven_day_end, keywords)
    layer_query_mapping[f"{crime} 28-Day"] = build_sql(twenty_eight_day_start, twenty_eight_day_end, keywords)
    layer_query_mapping[f"{crime} YTD"] = build_sql_ytd(keywords)

for layer_name, query in layer_query_mapping.items():
    lyr = map_obj.listLayers(layer_name)[0]
    lyr.definitionQuery = query

# Layout export
layout = [lyt for lyt in project.listLayouts() if lyt.name.lower().startswith("crime_reporting_layout")][0]
crime_types = list(keywords_by_crime.keys())
base_layers = ["City Boundaries", "Human Geography Dark Label", "Human Geography Dark Detail", "Human Geography Dark Base"]

for crime in crime_types:
    visible_layers = []

    # Set visibility
    for lyr in map_obj.listLayers():
        if crime in lyr.name:
            lyr.visible = True
            visible_layers.append(lyr)
        elif any(base in lyr.name for base in base_layers):
            lyr.visible = True
        else:
            lyr.visible = False

    # Set extent
    extent = None
    for lyr in visible_layers:
        try:
            ext = lyr.getExtent()
            if extent:
                extent = extent.union(ext)
            else:
                extent = ext
        except:
            continue

    if extent:
        map_obj.defaultCamera.setExtent(extent)

    # Export PDF
    out_name = f"{crime.replace(' ', '_')}_{report_name}_{report_due_date}.pdf"
    output_path = os.path.join(report_folder, out_name)
    layout.exportToPDF(output_path)

arcpy.AddMessage(f"Reports exported to: {report_folder}")
You can now run this in your template project and it will:

Clear conflicting visibility

Preserve your base map

Auto-zoom to active data

Export PDFs into a folder labeled with the Report_Name_Report_Due_Date. Would you like to walk through scheduling this script next? You said:
Burglary_-_Auto_C05W18_2025_05_06.pdf
PDF
Burglary_-_Comm_&_Res_C05W18_2025_05_06.pdf
PDF
updated script was added, automation was run, the following is the messages I received:

ScriptWeekly Crime Report
=====================
Tool Path

C:\GIS_Tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Friday, May 2, 2025 7:53:45 PM
Reports exported to: C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C05W18_2025_05_06
Succeeded at Friday, May 2, 2025 7:54:37 PM (Elapsed Time: 52.10 seconds)  

the legend is still missing and the zoom is not close enough. maybe both heat maps need to set to 60 % transparency   
ChatGPT said:
Thanks for confirming and sharing the results. Here's a breakdown of the two issues:
‚ùå Legend Not Appearing
From the PDFs you attached, the legend frame is present but empty, which typically means:

The legend is linked to a map frame that has no visible or valid layer symbology at export time. Or the layers are group layers and their symbology is not included by default in the legend. ‚úÖ Fix:

Ensure the legend is linked to the correct map frame (the one showing your crime layers). In the Layout View in ArcGIS Pro:

Click the Legend. In the Contents pane, expand it. Right-click each group/layer and check ‚ÄúInclude in Legend‚Äù. Avoid hiding group layers if the child layers are visible and should appear in the legend. Also ensure each visible layer has valid and visible symbology, like heatmaps or symbols. ‚ùå Map Not Zooming Properly
You're right ‚Äî the exported maps are zoomed out and not centered on the crime locations. ‚úÖ Fix:

Ensure getExtent() is getting meaningful extents:

This only works if the layer has features matching the definition query. If you're using group layers, make sure you‚Äôre zooming to child layers that are feature layers (not the group container). üîÅ Improved logic:
We can enhance the code to:

Traverse inside group layers to find the first visible feature layer with valid geometry. Zoom based on that. üîß Optional Enhancements (based on your comments):
Update heatmap transparency for 7-Day and 28-Day to 60%. Ensure both heatmap symbology and visibility are consistently applied. Explicitly include basemap layers in the legend if needed. Would you like me to integrate these fixes into the script for you now? You said:
Uploaded image
I updated the symbology for all 28-Day layers to heat map to purple, red, yellow. after implomenting the above edits update the script
ChatGPT said:
Perfect ‚Äî thank you for updating the symbology. Since you‚Äôve:

‚úÖ Adjusted all 28-Day layers to the correct Heat Map color scheme (Dark Magenta ‚Üí Red ‚Üí Yellow). ‚úÖ Requested all heatmap transparency be set to 60%. ‚úÖ Noted issues with map zoom and missing legend. ‚úÖ Ensured that the base layers should always be visible. ‚úÖ I will now proceed to update the script with:
Improved legend handling ‚Äì force refresh + make sure valid layers are visible. Map zoom logic ‚Äì refined to get extent from visible child layers (not just parent groups). Set transparency to 60% for all layers with "28-Day" or "YTD" in the name and using heatmaps. Ensure basemap layers are always visible. ‚úÖ Support for the updated layout name "Crime_Reporting_Layout1". Please confirm if you‚Äôd like to:

Also update 7-Day symbology programmatically (e.g., red points, 0% transparency). Include any other layout element (title text, dynamic date, etc.). Would you like those additions included before I update the script? You said:
yes to the 7-Day
no to include any other layouts
ChatGPT said:
The script has been updated to reflect the new symbology rules:

60% transparency has been applied to all 28-Day and YTD layers. 0% transparency for all 7-Day layers. Let‚Äôs now re-run the automation and verify:

The transparency is applying correctly. The layout includes the legend and zooms in appropriately. Would you like me to queue anything else after this verification run? Provide Feedback | View Changes | Contribute. You said:
Uploaded image
you want me to keep all the legend items checked? ChatGPT said:
Yes ‚Äî keep all the legend items checked. Here's why:

The script dynamically controls layer visibility during export. Only the visible layers for the current crime category will appear on the layout and legend at export time. Having all legend items checked ensures ArcGIS Pro knows which items to include, but only the visible ones will be exported per cycle. So no need to toggle legend items manually ‚Äî the script handles that for each crime map. Would you like the layout legend to appear in a more compact format or styled differently? Provide Feedback | View Changes | Contribute. You said:
what are the format options
ChatGPT said:
ArcGIS Pro offers a variety of formatting options for legends to improve clarity, layout fit, and design. Here's a breakdown of the key legend format options you can customize in your layout:

üîß Legend Formatting Options
1. Legend Arrangement
Layer arrangement: Single column (default), or multiple columns. Item order: By layer order or manually sorted. 2. Patch Formatting
Customize symbol size (patch size), shape (e.g., square, circle), and spacing between patches. 3. Grouping & Headings
Group layers under custom category headings (e.g., "Theft Crimes", "Violent Crimes"). Toggle visibility of group headings. 4. Label Options
Show or hide: Layer names, headings, class labels (e.g., ‚ÄúDense‚Äù, ‚ÄúSparse‚Äù). Customize font style, size, bold, italics, or color. 5. Spacing & Margins
Adjust column spacing, legend gap between items, and margins for padding. 6. Border and Background
Add a border, background color, and drop shadow for better visual separation from the map. 7. Wrap Text
Enable text wrapping to keep long layer names from running off the layout. 8. Legend Title
Add a custom title (e.g., ‚ÄúCrime Distribution Overview‚Äù). Format title separately from the rest of the legend. Would you like me to suggest a recommended setup for your weekly crime report legend layout? You said:
yes
ChatGPT said:
Great! Here's a recommended legend formatting setup tailored for your Weekly Crime Report layout to ensure clarity, professionalism, and visual balance:

‚úÖ Recommended Legend Setup
üìå General Settings
Title: Crime Activity Summary

Font: Arial Bold, 12‚Äì14 pt

Placement: Centered or left-aligned above legend

Legend Position: Upper right of layout (consistent with your reports)

Background: White or 80‚Äì90% transparent dark gray

Border: 1 pt solid black or dark gray (optional for visual clarity)

Shadow: Enabled (subtle)

üìö Grouping
Group your layers by crime type:

MV Theft

Burglary ‚Äì Auto

Burglary ‚Äì Comm & Res

Robbery

Sexual Offenses

Within each group, list:

7-Day ‚Äì red dot

28-Day ‚Äì purple/yellow heat map

YTD ‚Äì blue/cyan heat map

üí° Use Group Headings (Insert > Legend Group) for each crime category. üñºÔ∏è Patch Format
Point Symbols (7-Day):

Patch shape: Circle

Size: ~12 pt

Heat Maps (28-Day & YTD):

Patch shape: Rectangle

Size: Width 15‚Äì20 pt, Height 8‚Äì10 pt

Keep Sparse-to-Dense gradient visible

üìù Text Formatting
Layer Name (e.g., "MV Theft 28-Day")

Font: Arial Regular, 10 pt

Keep casing consistent (e.g., title case)

Class Labels ("Sparse", "Dense")

Font: Arial Italic, 8 pt

Consider removing if legend space is limited

Spacing

Vertical spacing between items: 4‚Äì6 pts

Indentation for symbol labels: 6‚Äì8 pts

üîÑ Auto-Update
Make sure Legend Items are set to Auto Update so it reflects visibility changes in your map. Would you like me to help you apply these directly in the template or update the script to clean up and apply legend grouping logic automatically? You said:
I agree with you recommendations, also add Single column
7-Day Layer Name only
28-Day & YTD Layer Name and Label (or layer name)  
ChatGPT said:
Perfect ‚Äî thanks for confirming! Here's how to apply the formatting in ArcGIS Pro to align with your preferences and the recommendations:

‚úÖ Legend Formatting Instructions (Manually in Template)
1. Legend Structure
Open Layout View

Right-click the Legend > Properties

2. Single Column Layout
In the Legend Format tab:

Set Arrangement to: Single Column

Set Spacing ‚Üí Vertical Spacing: 6 pt

üî¥ 7-Day Layers
Show only layer name

Expand the legend in the Contents pane

Uncheck sub-items (like "Symbol" or "Labels") for each 7-Day layer

Result: only the red dot and name like MV Theft 7-Day is shown

üü£ 28-Day & üîµ YTD Layers
Show layer name and color ramp

Expand the 28-Day/YTD layers in the Legend

Make sure:

Layer name is checked ‚úÖ

Legend Patch or Label (Sparse ‚Üí Dense) is also checked ‚úÖ

üé® Additional Formatting
Legend Title
Rename the legend to:
Crime Activity Summary
(Right-click > Properties > General tab > Title)

Background & Border
In Legend Properties:

Enable Background Fill (suggest white or 85% gray)

Add 1 pt Border (optional)

Optional: Update Script to Reflect These
I can also revise the Python script to:

Auto-hide 28-Day/YTD layers not related to the current crime export

Ensure 7-Day shows only name

Maintain base layers and layout focus

Would you like me to apply these legend formatting settings in the script or just leave it as a manual step in the template? You said:
please update the 28-Day layers to heat map to purple, red, yellow. ChatGPT said:

Analysis errored
Always show details

import arcpy

# Get current ArcGIS Pro project and map
project = arcpy.mp.ArcGISProject("CURRENT")
map_obj = project.listMaps()[0]

# Color ramp name used for 28-Day layers
desired_color_ramp = "Heat Map: Dark Magenta-Yellow - Semitransparent"

# Apply symbology update to all 28-Day layers
for layer in map_obj.listLayers():
    if "28-Day" in layer.name and layer.isFeatureLayer:
        sym = layer.symbology
        if sym.renderer.type == "HeatMapRenderer":
            sym.colorRamp = desired_color_ramp
            layer.symbology = sym

"Updated 28-Day layers to use the 'Dark Magenta-Yellow - Semitransparent' heat map symbology." Analysis errored
Always show details

import arcpy

# Get current ArcGIS Pro project and map
project = arcpy.mp.ArcGISProject("CURRENT")
map_obj = project.listMaps()[0]

# Color ramp name used for 28-Day layers
desired_color_ramp = "Heat Map: Dark Magenta-Yellow - Semitransparent"

# Apply symbology update to all 28-Day layers
for layer in map_obj.listLayers():
    if "28-Day" in layer.name and layer.isFeatureLayer:
        sym = layer.symbology
        if sym.renderer.type == "HeatMapRenderer":
            sym.colorRamp = desired_color_ramp
            layer.symbology = sym

"28-Day layers updated to 'Dark Magenta-Yellow - Semitransparent' heat map style." ---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
Cell In[1], line 1
----> 1 import arcpy
      3 # Get current ArcGIS Pro project and map
      4 project = arcpy.mp.ArcGISProject("CURRENT")

ModuleNotFoundError: No module named 'arcpy'
It looks like the script attempted to run outside of ArcGIS Pro‚Äôs Python environment, which doesn't support the arcpy module here. To apply the heat map color ramp update:

Manual Update Steps in ArcGIS Pro:
Open ArcGIS Pro and your project. In the Contents pane, select any layer with 28-Day in the name. Open the Symbology pane. Change the Color Scheme to:
"Heat Map: Dark Magenta-Yellow - Semitransparent"
(or choose it from the heat map category under ‚ÄúColor Scheme‚Äù)

Repeat for all 28-Day layers. Would you like a Python script you can run inside ArcGIS Pro's Python window to do this automatically? You said:
manual update done
ChatGPT said:
Perfect ‚Äî with the 28-Day symbology manually updated to the magenta-yellow heat map, you're now ready for the final script adjustments. Confirmed Goals for Script Update
7-Day Symbology ‚Üí Keep existing square symbol (unchanged). 28-Day Layers ‚Üí Symbology already manually updated. Legend:

Format: Single column

7-Day: Layer name only

28-Day & YTD: Layer name and label

Transparency (you previously requested this):

Apply 60% transparency to both 7-Day and 28-Day layers. Shall I now proceed to update the script with the following:
Enforce 60% transparency on 7-Day and 28-Day layers? Ensure the legend is programmatically configured as specified? Keep base layers (e.g., city boundaries) always visible? Please confirm and I‚Äôll proceed. You said:
Enforce 60% transparency on 28-Day and YTD only, 0% transparency  on 7-day. Keep City Boundaries, Human Geography Dark Label, Human Geography Dark Detail and Human Geography Dark Base
ChatGPT said:
The script has been updated with the following changes:

28-Day and YTD layers now have 60% transparency. 7-Day layers have 0% transparency. City Boundaries and all Human Geography Dark layers remain visible for every layout export. You're set to run the automation again to validate. Let me know once you've reviewed the updated layout exports. Provide Feedback | View Changes | Contribute. You said:
Burglary_-_Auto_C05W18_2025_05_06.pdf
PDF
Burglary_-_Comm_&_Res_C05W18_2025_05_06.pdf
PDF
Layout is not zoomed in enough, legend, scale bar and north arrow now visible
ChatGPT said:
Thanks for confirming and sharing the latest output. Here's what I'm seeing from the current exported layouts:

‚úÖ What‚Äôs Working
Legend, scale bar, and north arrow are now visible. Basemap and boundaries (e.g., City Boundaries, Human Geography Dark layers) are showing properly. Layer symbology for heatmaps is applying consistently. ‚ö†Ô∏è What Still Needs Improvement
1. Zoom Not Tight Enough
The maps are still zoomed out too far ‚Äî likely because some of the getExtent() calls aren't fully capturing the visible feature data (especially for heatmaps or if some features are small/dense). ‚úÖ Updated Script Fixes (Next Step)
We'll now apply the following:

Enforce 60% transparency on 28-Day and YTD, and 0% transparency on 7-Day. Adjust the zooming logic to ensure a closer zoom by tightening the extent using a buffered envelope around the visible layers. Would you like me to apply those changes and provide the new version of the script now? You said:
Uploaded image
Attachment 1: normal layout
Attachment 2: zoomed in so the heat maps,and or point show with street names to give more context. Is there a setting that zooms in as close as possible where all the symbology is visible? ChatGPT said:
Yes ‚Äî there is a way to zoom in automatically so all symbology (heatmaps, points, etc.) is clearly visible with contextual street labels. This involves improving how the script sets

You said:
Uploaded image
ChatGPT said:
You said:
\[media pointer="file-service://file-WoL9y1hdrK7Stn2f7GXo1b"]
Attachment 1: normal layout
Attachment 2: zoomed in so the heat maps,and or point show with street names to give more context. Is there a setting that zooms in as close as possible where all the symbology is visible? ChatGPT said:
You said:
? ChatGPT said:
Yes ‚Äî to ensure your layout zooms in as close as possible while still capturing all visible symbology, you can programmatically zoom to the visible extent of active layers, then apply a slight buffer to avoid cropping any features. Here's how to improve the zooming behavior in your script:

‚úÖ Recommended Fix
Replace your current zoom logic with this:

from arcpy import mapping

# Set extent based on visible data + buffer
extent = None
for lyr in visible_layers:
    if lyr.isFeatureLayer and lyr.visible:
        try:
            ext = lyr.getExtent()
            if extent:
                extent = extent.union(ext)
            else:
                extent = ext
        except:
            continue

# Apply buffer to zoom in more tightly
if extent:
    buffer_x = (extent.XMax - extent.XMin) * 0.1
    buffer_y = (extent.YMax - extent.YMin) * 0.1
    tight_extent = arcpy.Extent(
        extent.XMin + buffer_x,
        extent.YMin + buffer_y,
        extent.XMax - buffer_x,
        extent.YMax - buffer_y
    )
    map_obj.defaultCamera.setExtent(tight_extent)
üîç What This Does:
Computes a tight bounding box of all currently visible features. Applies a 10% inward buffer on all sides to bring the layout in closer while still keeping features and labels visible. Improves legibility of map elements like street names and heat spot clarity. Would you like me to fully integrate this into the current export script for you? You said:
yes
ChatGPT said:
‚úÖ Script updated with:

60% transparency on 28-Day and YTD layers

0% transparency on 7-Day layers

Layout zooms in more tightly by buffering the extent

All base layers remain visible

Go ahead and run it‚Äîlet‚Äôs check those layout exports! Provide Feedback | View Changes | Contribute. You said:
MV_Theft_C05W18_2025_05_06.pdf
PDF
message after updating the script:

ScriptWeekly Crime Report
=====================
Tool Path

C:\GIS_Tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================


layout is missing legend and is not zoomed in enough as I described eariler 
Messages

Start Time: Friday, May 2, 2025 9:29:37 PM
Reports exported to: C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C05W18_2025_05_06
Succeeded at Friday, May 2, 2025 9:30:05 PM (Elapsed Time: 28.00 seconds)
ChatGPT said:
Thanks for sharing the output layout. Here's a breakdown of what‚Äôs happening and the next steps we should take:

‚úÖ Script Output
The script is successfully exporting to the correct folder, and the report generation process completed without error. ‚ö†Ô∏è Current Problems
Based on your output PDF and description:

Legend is missing ‚Äì the layout object doesn't appear to include or populate a visible legend. Zoom is too wide ‚Äì the layout zooms to the full city extent instead of just the visible crime symbology. üîß Fixes We‚Äôll Implement
1. Legend Configuration
We will:

Identify the legend element on the layout (likely named "Legend"). Clear and repopulate it only with visible layers during each crime type export. Set legend format:

7-Day ‚Üí show layer name only

28-Day & YTD ‚Üí show layer name + label

Legend layout = Single Column

2. Improved Zoom
We will:

Use the map frame from the layout. Set extent based on only the active visible layers (excluding basemaps). Apply a 15% buffer around the extent so map features are not flush with the edge. üõ†Ô∏è Would you like me to provide the updated script now with these fixes applied? This will resolve both the missing legend and the zoom issue in one go. You said:
yes
ChatGPT said:
‚úÖ Script updated! Your automation now:

Applies 60% transparency to 28-Day and YTD layers

Keeps 7-Day layers at 0% transparency

Preserves base map visibility (City Boundaries, Human Geography layers)

Zooms in with 15% padding to ensure symbology and context are visible

Adds a legend with single-column formatting:

7-Day: Layer name only

28-Day & YTD: Layer name and label

Run it again and let me know how the updated layout looks! Would you like the legend title updated as well (e.g., to ‚ÄúCrime Types‚Äù)? You said:
ScriptWeekly Crime Report
=====================
Tool Path

C:\GIS_Tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Friday, May 2, 2025 9:37:15 PM
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\Code\Python\weekly_crime_report.py", line 95, in <module>
Ôªø    legend.clear()
Ôªø    ^^^^^^^^^^^^
ÔªøAttributeError: 'LegendElement' object has no attribute 'clear'

Failed script ScriptWeekly Crime Report...
Failed to execute (WeeklyCrimeReport). Failed at Friday, May 2, 2025 9:37:20 PM (Elapsed Time: 4.91 seconds)
ChatGPT said:
Thanks for the report ‚Äî the error happened because LegendElement in ArcPy doesn't support .clear() as a method. We'll update the script to properly manage the legend contents using supported ArcPy properties. ‚úÖ Fix plan:

Remove the incorrect .clear() method call

Replace it with legend.autoAdd = True and control layer visibility directly

Optionally, set legend.items or use layer visibility to drive legend content

I'll now update the script with the correct legend handling ‚Äî ready? You said:
ready
ChatGPT said:
‚úÖ Script has been updated to include:

Layer transparency rules (60% for 28-Day/YTD, 0% for 7-Day)

Automatic legend updating using legend.autoAdd = True

Layout zooming based on feature extent

You're now ready to re-run the script to test these changes. Would you like to update the template project before running? You said:
MV_Theft_C05W18_2025_05_06.pdf
PDF
Robbery_C05W18_2025_05_06.pdf
PDF
Sexual_Offenses_C05W18_2025_05_06.pdf
PDF
ScriptWeekly Crime Report
=====================
Tool Path

C:\GIS_Tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Friday, May 2, 2025 9:40:52 PM

Layout is still broken. Reports exported to: C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C05W18_2025_05_06
Succeeded at Friday, May 2, 2025 9:41:12 PM (Elapsed Time: 19.60 seconds)
ChatGPT said:
Thanks for sharing the latest test results.