Here‚Äôs what‚Äôs next:

‚úÖ Next Step: Final Script Update
I‚Äôll now:

‚úÖ Embed your confirmed definition queries directly into the automation script. ‚úÖ Lock in the correct export path with the naming format:

C05W18_2025_05_06\Burglary_-_Auto_C05W18_2025_05_06.pdf
‚úÖ Use proper map zooming and refresh logic. ‚úÖ Ensure legend is populated with visible layers. üß± Before I Drop the Script:
Can you confirm these two quick items are correct:

üî† Field Names:

calltype

disposition

calldate

üìÇ Final Export Folder:

C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C05W18_2025_05_06
If both are correct, I‚Äôll push the final Python script for your toolbox tool. You said:
I have the attribute table open for the Sexual Offenses YTD. The heat map populated. advise and provide steps to get the Field Names
ChatGPT said:
Perfect ‚Äî here‚Äôs how to get the exact field names for your Sexual Offenses YTD layer so we can 100% verify everything is in sync:

‚úÖ Method 1: Use the Fields View (Recommended)
In the Contents pane, right-click the Sexual Offenses YTD layer. Go to Design > Fields (or just Fields depending on your ArcGIS Pro version). A new tab will open called Fields: Sexual Offenses YTD. In the table, find the column called Field Name ‚Äî that's what your SQL and script must use. Scroll and look for the entries that match your field aliases:

‚ÄúCall Type‚Äù

‚ÄúDisposition‚Äù

‚ÄúCall Date‚Äù

Copy the Field Name (not Alias Name) values and paste them here. ‚úÖ Method 2: Hover in the Attribute Table (Quick)
Open the attribute table for Sexual Offenses YTD. Hover your mouse over the column headers (e.g., ‚ÄúCall Type‚Äù). A small tooltip should appear ‚Äî it will display the actual field name. Once you paste those 3 field names here, I‚Äôll finalize the script knowing it‚Äôs a perfect match for your hosted layer. Would you like a screenshot example of the Fields View as a reference? You said:
I right clicked the Field Name, selected copy but it will not past. should i type it in? I am worried of leading/trailing spaces
ChatGPT said:
Yes ‚Äî it‚Äôs smart to be cautious, especially with leading/trailing spaces. Here‚Äôs a safer way:

‚úÖ Use This Trick to Get Exact Field Names (No Typos)
In the Fields View, double-click the Field Name (not Alias). Hit Ctrl+C to copy. Open Notepad (or any plain text editor). Paste the field name into Notepad using Ctrl+V. This way:

You can see any hidden spaces. You‚Äôll avoid accidentally copying the alias or header label. It ensures exact spelling and casing. Once pasted into Notepad, copy from there and paste here. If all 3 come through clean, I‚Äôll wrap the script immediately. Let me know if you'd like me to wait while you do this. You said:
Uploaded image
Uploaded image
Uploaded image
ChatGPT said:
Perfect ‚Äî thank you for confirming. Based on the screenshots, the correct internal field names for the SQL definition queries are:

calldate for Call Date

disposition for Disposition

calltype for Call Type

You should use these internal names in your SQL expressions in the script and layer definition queries. For example, a corrected YTD query would look like this:

calldate >= date '2024-12-31' 
AND disposition LIKE '%report%' 
AND (
    calltype LIKE '%Vehicle Theft%' OR 
    calltype LIKE '%Commercial%' OR 
    calltype LIKE '%Residence%' OR 
    calltype LIKE '%Robbery%' OR 
    calltype LIKE '%Sexual%' OR 
    calltype LIKE '%Motor Vehicle Theft%'
)
Let‚Äôs move forward by applying this updated syntax to all relevant layers in your script. Do you want me to regenerate the SQL for all the crime types and sub-layers now using the corrected field names? You said:
yes
ChatGPT said:
Great ‚Äî here are the updated SQL definition queries for each layer using the correct field names: calldate, disposition, and calltype. üîπ Burglary - Auto
7-Day

calldate >= CURRENT_DATE - 7 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Auto%'
28-Day

calldate >= CURRENT_DATE - 28 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Auto%'
YTD

calldate >= DATE '2024-12-31' 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Auto%'
üîπ Burglary - Comm & Res
7-Day

calldate >= CURRENT_DATE - 7 
AND disposition LIKE '%report%' 
AND (calltype LIKE '%Commercial%' OR calltype LIKE '%Residence%')
28-Day

calldate >= CURRENT_DATE - 28 
AND disposition LIKE '%report%' 
AND (calltype LIKE '%Commercial%' OR calltype LIKE '%Residence%')
YTD

calldate >= DATE '2024-12-31' 
AND disposition LIKE '%report%' 
AND (calltype LIKE '%Commercial%' OR calltype LIKE '%Residence%')
üîπ Robbery
7-Day

calldate >= CURRENT_DATE - 7 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Robbery%'
28-Day

calldate >= CURRENT_DATE - 28 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Robbery%'
YTD

calldate >= DATE '2024-12-31' 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Robbery%'
üîπ Sexual Offenses
7-Day

calldate >= CURRENT_DATE - 7 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Sexual%'
28-Day

calldate >= CURRENT_DATE - 28 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Sexual%'
YTD

calldate >= DATE '2024-12-31' 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Sexual%'
üîπ MV Theft
7-Day

calldate >= CURRENT_DATE - 7 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Motor Vehicle Theft%'
28-Day

calldate >= CURRENT_DATE - 28 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Motor Vehicle Theft%'
YTD

calldate >= DATE '2024-12-31' 
AND disposition LIKE '%report%' 
AND calltype LIKE '%Motor Vehicle Theft%'
Would you like these applied to the script or want to manually verify in ArcGIS Pro first? You said:
if you add it to the code would I have to manually update all the layers or will the code do it when it is run? ChatGPT said:
The code will automatically apply all the definition queries to the correct layers when it runs ‚Äî no manual updates are needed in ArcGIS Pro each time. Here‚Äôs how that works:

The script uses the current reporting cycle dates from the Excel file. It builds SQL queries dynamically for each layer and time period (7-Day, 28-Day, YTD). Then it assigns those queries directly to the matching layers (e.g., MV Theft YTD, Robbery 28-Day, etc.). You just need to ensure the layer names in the map match the script exactly (they do right now). So once I add the updated SQL logic into the script, you‚Äôll only need to:

Run the script. Get the updated layout exports ‚Äî done! ‚úÖ Ready for me to embed those updated SQL rules in the script now? You said:
ok lets update the code
ChatGPT said:
‚úÖ The script has been updated to dynamically apply the correct SQL queries for all layers using field names from your hosted feature layer (calldate, disposition, calltype). It also generates a report folder named with the format: Report_Name_Submission_Date. üìù When the script runs, it will:

Assign the appropriate filters to all layers automatically. Create the new folder. Export the layout PDFs to that folder. üìå No manual layer updates are needed‚Äîthis script handles everything when executed. Would you like to run a test now or add auto-legend formatting and zoom adjustments next? Provide Feedback | View Changes | Contribute. You said:
I tested the script below is the errors received:

ScriptWeekly Crime Report
=====================
Tool Path

C:\Users\carucci_r\OneDrive - City of Hackensack\Documents üìë\ArcGIS\2025\2025_05_01_08_45_50_Test\gis_tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Friday, May 2, 2025 2:10:19 PM
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\Code\Python\weekly_crime_report.py", line 13, in <module>
Ôªø    cycle_df = pd.read_excel(csv_path)
Ôªø               ^^^^^^^^^^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\pandas\io\excel\_base.py", line 478, in read_excel
Ôªø    io = ExcelFile(io, storage_options=storage_options, engine=engine)
Ôªø         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\pandas\io\excel\_base.py", line 1500, in __init__
Ôªø    raise ValueError(
ÔªøValueError: Excel file format cannot be determined, you must specify an engine manually. Failed script ScriptWeekly Crime Report...
Failed to execute (WeeklyCrimeReport). Failed at Friday, May 2, 2025 2:10:42 PM (Elapsed Time: 22.13 seconds)
ChatGPT said:
Thanks for the update. The error is clear:

ValueError: Excel file format cannot be determined, you must specify an engine manually. üîç What this means:
pandas.read_excel() requires an engine (like openpyxl) to read .xlsx files in ArcGIS Pro‚Äôs Python environment, and that engine is not being automatically selected. ‚úÖ Fix:
In your script, change the line:

cycle_df = pd.read_excel(csv_path)
to:

cycle_df = pd.read_excel(csv_path, engine='openpyxl')
üìå Next Step:
Once you make that change, save the script and re-run the tool. It should now read the Excel file without issue. Would you like me to walk you through updating the script file in ArcGIS Pro? Provide Feedback | View Changes | Contribute. You said:
help with the walk through
ChatGPT said:
Absolutely ‚Äî here‚Äôs a step-by-step guide to edit your script in ArcGIS Pro to fix the Excel engine error. üõ† Step-by-Step: Edit Your Toolbox Script in ArcGIS Pro
1. Open the Toolbox
In the Catalog pane, go to your .tbx file (likely named CrimeAutomationTools.tbx). Expand it to show the script tool (probably WeeklyCrimeReport). Right-click on WeeklyCrimeReport, and select Edit. This opens the Python script in the ArcGIS Pro script editor. 2. Find This Line:
cycle_df = pd.read_excel(csv_path)
3. Replace It With:
cycle_df = pd.read_excel(csv_path, engine='openpyxl')
This tells pandas exactly which engine to use to read .xlsx files. 4. Save the Script
Click File > Save, or press Ctrl+S. 5. Re-run the Script Tool
Back in ArcGIS Pro, go to the Geoprocessing pane. Run the WeeklyCrimeReport tool again. Once you do that, the Excel read error should disappear. Let me know how it goes ‚Äî if any other error appears, I‚Äôll help you address it right away. Provide Feedback | View Changes | Contribute. You said:
ScriptWeekly Crime Report
=====================
Tool Path

C:\Users\carucci_r\OneDrive - City of Hackensack\Documents üìë\ArcGIS\2025\2025_05_01_08_45_50_Test\gis_tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Friday, May 2, 2025 2:15:20 PM
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\Code\Python\weekly_crime_report.py", line 13, in <module>
Ôªø    cycle_df = pd.read_excel(csv_path, engine='openpyxl')
Ôªø               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\pandas\io\excel\_base.py", line 478, in read_excel
Ôªø    io = ExcelFile(io, storage_options=storage_options, engine=engine)
Ôªø         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\pandas\io\excel\_base.py", line 1513, in __init__
Ôªø    self._reader = self._engines[engine](self._io, storage_options=storage_options)
Ôªø                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\pandas\io\excel\_openpyxl.py", line 549, in __init__
Ôªø    super().__init__(filepath_or_buffer, storage_options=storage_options)
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\pandas\io\excel\_base.py", line 540, in __init__
Ôªø    self.book = self.load_workbook(self.handles.handle)
Ôªø                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\pandas\io\excel\_openpyxl.py", line 560, in load_workbook
Ôªø    return load_workbook(
Ôªø           ^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\openpyxl\reader\excel.py", line 344, in load_workbook
Ôªø    reader = ExcelReader(filename, read_only, keep_vba,
Ôªø             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\openpyxl\reader\excel.py", line 123, in __init__
Ôªø    self.archive = _validate_archive(fn)
Ôªø                   ^^^^^^^^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\site-packages\openpyxl\reader\excel.py", line 95, in _validate_archive
Ôªø    archive = ZipFile(filename, 'r')
Ôªø              ^^^^^^^^^^^^^^^^^^^^^^
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\zipfile.py", line 1313, in __init__
Ôªø    self._RealGetContents()
Ôªø  File "C:\Program Files\ArcGIS\Pro\bin\Python\envs\arcgispro-py3\Lib\zipfile.py", line 1380, in _RealGetContents
Ôªø    raise BadZipFile("File is not a zip file")
Ôªøzipfile.BadZipFile: File is not a zip file

Failed script ScriptWeekly Crime Report...
Failed to execute (WeeklyCrimeReport). Failed at Friday, May 2, 2025 2:15:24 PM (Elapsed Time: 3.98 seconds)
ChatGPT said:
Thanks ‚Äî this error confirms the issue:

zipfile.BadZipFile: File is not a zip file

üîç What this means:
You're trying to read a CSV file using pd.read_excel() ‚Äî but Excel readers only work with .xlsx or .xls formats, which are actually ZIP-based files. Since the file is really a .csv, we must use pd.read_csv() instead. ‚úÖ Fix the Script Line
Change this line:

cycle_df = pd.read_excel(csv_path, engine='openpyxl')
To:

cycle_df = pd.read_csv(csv_path)
Once you make that one-line change in your script, save it and rerun the tool ‚Äî it should work correctly and read the file with no errors. Let me know if you'd like me to walk through editing it again. You said:
Burglary_-_Auto_C05W18_2025_05_06.pdf
PDF
Burglary_-_Comm_&_Res_C05W18_2025_05_06.pdf
PDF
MV_Theft_C05W18_2025_05_06.pdf
PDF
Robbery_C05W18_2025_05_06.pdf
PDF
No warnings were received. Below is the messages I did get:

ScriptWeekly Crime Report
=====================
Tool Path

C:\Users\carucci_r\OneDrive - City of Hackensack\Documents üìë\ArcGIS\2025\2025_05_01_08_45_50_Test\gis_tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================

The layout are not correct, see attached 
Parameters

=====================
Messages

Start Time: Friday, May 2, 2025 2:18:20 PM
Reports exported to: C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C05W18_2025_05_06
Succeeded at Friday, May 2, 2025 2:18:45 PM (Elapsed Time: 24.94 seconds)
ChatGPT said:
Thanks ‚Äî based on the exported PDFs you uploaded, here are the confirmed layout issues:

üîç Layout Problems
üó∫ Map is not visible:

Each PDF includes a legend and scale bar, but the map frame is empty ‚Äî this means either:

No visible layers were drawn in the extent

Or the layout‚Äôs map frame is not linked properly to your map document

üìè Map extent is not zoomed:

There‚Äôs a fixed scale bar but no features showing, even though queries ran. üß≠ Legend shows only the title (no items):

The legend appears as a placeholder. Likely caused by either:

Layers not drawn

Layers hidden from the legend group

Legend not referencing active map frame properly

‚úÖ Here's What to Check Next in the Template Project
Open the layout:

Go to the layout in your .aprx template project. Click the map frame on the layout. In the Layout tab or the Element Properties, confirm:

It is linked to the correct map (not some default or empty map). You should see ‚ÄúMap Frame: YourMapName‚Äù

Test layer visibility:

In the map view (not layout), turn on a layer manually (e.g., Robbery YTD) and zoom to it. Now go back to the layout ‚Äî does the map frame update? If not, relink the map frame to the correct map. Inspect the Legend:

Click the legend in the layout. In the Contents pane, right-click ‚Üí Properties. Ensure the legend is referencing the correct layers. Try deleting the legend and inserting a new one to auto-pick up visible layers. Would You Like Me To:
‚úÖ Help you correct this layout in the template right now

üì¶ Or export an example .aprx template you can use that‚Äôs pre-set with layout formatting? Let me know how you‚Äôd like to proceed. We‚Äôre very close! Provide Feedback | View Changes | Contribute. You said:
In the templet and I had 2 layouts. I deleted one and the layout in the project is named "Crime_Reporting_Layout". I opened the test project and ran the script. No errors and received the below message. The exported layouts are incorrect. I will attach the exported layouts seperatily. ScriptWeekly Crime Report
=====================
Tool Path

C:\Users\carucci_r\OneDrive - City of Hackensack\Documents üìë\ArcGIS\2025\2025_05_01_08_45_50_Test\gis_tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Friday, May 2, 2025 2:27:53 PM
Reports exported to: C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C05W18_2025_05_06
Succeeded at Friday, May 2, 2025 2:28:14 PM (Elapsed Time: 21.00 seconds)
ChatGPT said:
Perfect ‚Äî thank you for confirming the layout is now named Crime_Reporting_Layout and that the script ran successfully. That helps narrow it down. Let‚Äôs fix the remaining layout formatting issues. Please go ahead and upload the exported PDFs from this most recent run ‚Äî I‚Äôll analyze them to determine:

If the map frame is drawing the right data

Whether symbology and extent are being applied

Why the legend isn't populating

Once I review them, I‚Äôll walk you through exactly what to tweak in the template layout to ensure clean, formatted exports moving forward. Ready when you are ‚Äî please upload the exported layouts. You said:
Burglary_-_Auto_C05W18_2025_05_06.pdf
PDF
Burglary_-_Comm_&_Res_C05W18_2025_05_06.pdf
PDF
MV_Theft_C05W18_2025_05_06.pdf
PDF
ChatGPT said:
Thanks for sharing the exported layouts ‚Äî I‚Äôve reviewed the PDFs and here‚Äôs a breakdown of what‚Äôs happening:

‚ùå Observed Issues in All Layouts
üó∫ No map content drawn

The layout shows a blank map frame ‚Äî meaning no visible features or basemap are rendered. üìú Legend is blank

Only the word "Legend" appears; no layer items are listed. This suggests:

Layers are either not drawing at export time, or

The legend is not linked to the layers currently visible in the map frame. üìê Layout scale bar is present

This confirms the layout is functioning ‚Äî just not drawing correct content. üîç Root Cause Likely
The map frame in the layout (Crime_Reporting_Layout) might not be:

Properly linked to the map object (map_obj = project.listMaps()[0])

Or the map frame doesn't redraw during script execution if it‚Äôs frozen or misaligned. ‚úÖ Recommended Next Steps
üõ† Fix 1: Confirm Map Frame Link
Open your template project in ArcGIS Pro. Open the Crime_Reporting_Layout. Click on the map frame. In the Contents pane, ensure the map frame‚Äôs associated map is the correct one (with your analysis layers). You should see it listed as Map Frame: YourMapName in the Element Properties. If it says ‚ÄúMap Frame: Map1‚Äù or something unexpected, relink it to your actual map. üõ† Fix 2: Confirm Legend Settings
Click the Legend item in the layout. Check Contents pane > Legend ‚Äî it should list the layers. If it's empty, delete the legend and insert a new one:

Insert ‚Üí Legend ‚Üí Click on the layout

ArcGIS will auto-attach visible layers

üõ† Fix 3: Enable Dynamic Extent (Optional)
If the map frame is frozen at a fixed scale or position:

Right-click the map frame ‚Üí Properties

In the Display tab, uncheck ‚ÄúFixed Extent‚Äù if it's enabled. Would you like me to walk you through those in ArcGIS Pro, or help update the script to force visibility and frame refresh automatically? Provide Feedback | View Changes | Contribute. You said:
Uploaded image
I named the layout "Crime_Reporting_Layout1"
ChatGPT said:
Perfect ‚Äî thanks for confirming and sharing the screenshot. ‚úÖ Observations:
Your layout is named Crime_Reporting_Layout1

The legend is correctly populating and showing layer symbology

The map is drawing correctly inside the layout frame

Layers are toggled visible and match the legend

üõ† What Needs to Be Fixed in the Script:
Your script is currently looking for the layout using:

layout = project.listLayouts("Crime_Reporting_Layout")[0]
But your actual layout is now Crime_Reporting_Layout1 ‚Äî this mismatch is the reason your exported PDFs are blank. ‚úÖ Fix:
Update your script line to:

layout = project.listLayouts("Crime_Reporting_Layout1")[0]
Alternatively, if you want the script to work more flexibly across future renames:

layout = project.listLayouts()[0]  # Grabs the first layout in the project
Make sure the layout you want is at the top of the layout list in ArcGIS Pro if you choose this method. Would you like me to help update this directly in your .py file now? Provide Feedback | View Changes | Contribute. You said:
Is this correct:

import arcpy
import pandas as pd
from datetime import datetime
import os

# Set paths
csv_path = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\DateRelated\7Day_28Day_Cycle_20250414.csv"
export_root = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports"
project = arcpy.mp.ArcGISProject("CURRENT")
map_obj = project.listMaps()[0]  # Assumes one map in project

# Load cycle control table
cycle_df = pd.read_csv(csv_path)
if not any(cycle_df['Is_Due'] == True):
    raise ValueError("No cycle is marked as 'Is_Due = True' in the cycle table.") current_cycle = cycle_df[cycle_df['Is_Due'] == True].iloc[0]

# Extract dates and report name
seven_day_start = pd.to_datetime(current_cycle['7_Day_Start']).strftime('%Y-%m-%d')
seven_day_end = pd.to_datetime(current_cycle['7_Day_End']).strftime('%Y-%m-%d')
twenty_eight_day_start = pd.to_datetime(current_cycle['28_Day_Start']).strftime('%Y-%m-%d')
twenty_eight_day_end = pd.to_datetime(current_cycle['28_Day_End']).strftime('%Y-%m-%d')
ytd_start = '2024-12-31'
report_name = current_cycle['Report_Name']
report_due_date = pd.to_datetime(current_cycle['Report_Due_Date']).strftime('%Y_%m_%d')

# Create output folder for this report
report_folder = os.path.join(export_root, f"{report_name}_{report_due_date}")
os.makedirs(report_folder, exist_ok=True)

# Keyword filters for each crime type
keywords_by_crime = {
    "Burglary - Auto": ['auto'],
    "Burglary - Comm & Res": ['residence', 'commercial'],
    "Robbery": ['robbery'],
    "Sexual Offenses": ['sexual'],
    "MV Theft": ['motor vehicle theft']
}

# Construct SQL definitions
def build_sql(start_date, end_date, keywords):
    calltype_clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return (
        f"calldate >= date '{start_date}' AND calldate <= date '{end_date}' "
        f"AND disposition LIKE '%report%' AND ({calltype_clause})"
    )

def build_sql_ytd(keywords):
    calltype_clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return (
        f"calldate >= date '{ytd_start}' "
        f"AND disposition LIKE '%report%' AND ({calltype_clause})"
    )

# Map layers to definition queries
layer_query_mapping = {}
for crime, keywords in keywords_by_crime.items():
    layer_query_mapping[f"{crime} 7-Day"] = build_sql(seven_day_start, seven_day_end, keywords)
    layer_query_mapping[f"{crime} 28-Day"] = build_sql(twenty_eight_day_start, twenty_eight_day_end, keywords)
    layer_query_mapping[f"{crime} YTD"] = build_sql_ytd(keywords)

# Apply definition queries
for layer_name, query in layer_query_mapping.items():
    lyr = map_obj.listLayers(layer_name)[0]
    lyr.definitionQuery = query

# Set layout and symbology export
layout = project.listLayouts()[0]  # Grabs the first layout in the project
crime_types = list(keywords_by_crime.keys())
for crime in crime_types:
    visible_layers = []

    # Turn visibility on for this crime type
    for lyr in map_obj.listLayers():
        is_crime = crime in lyr.name
        lyr.visible = is_crime
        if is_crime:
            visible_layers.append(lyr)

    # Zoom to visible data
    extent = None
    for lyr in visible_layers:
        try:
            ext = lyr.getExtent()
            if extent:
                extent = extent.union(ext)
            else:
                extent = ext
        except:
            continue

    if extent:
        map_obj.defaultCamera.setExtent(extent)

    # Export layout
    output_path = os.path.join(report_folder, f"{crime.replace(' ', '_')}_{report_name}_{report_due_date}.pdf")
    layout.exportToPDF(output_path)

arcpy.AddMessage(f"Reports exported to: {report_folder}")
ChatGPT said:
Yes ‚Äî that script looks very well structured and nearly complete for your goal. ‚úÖ What It Does Correctly:
Loads the correct 7-Day, 28-Day, and YTD dates from your control table. Filters layers by keyword in calltype, and only if disposition contains "report". Applies the correct SQL definition queries to each layer. Toggles layer visibility per crime type and zooms to extent. Exports layouts named correctly with crime type + report name + due date. Saves them in an automatically created report folder. Uses project.listLayouts()[0] which will target the first layout (you can update this to "Crime_Reporting_Layout1" if needed). üîÅ Suggestion for Clarity & Maintenance
You may optionally want to explicitly target your layout:

layout = project.listLayouts("Crime_Reporting_Layout1")[0]
This avoids unexpected issues if the layout order changes in the project. ‚ö† If Your Output PDFs Are Still Incomplete:
Make sure the following are all true in your .aprx:

The layout name is exactly "Crime_Reporting_Layout1". The Map Frame in the layout is linked to the correct map (Map). The Legend in the layout includes all layer groups or is set to "Only show visible layers". The City Boundaries layer is always on (or scripted to toggle). You're ready to run with this version. Would you like help integrating:

Optional constant layers (e.g. City Boundaries)? Automatically refreshing the legend?