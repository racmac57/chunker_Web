Failed at Sunday, May 4, 2025 3:58:37 PM (Elapsed Time: 2.78 seconds)
ChatGPT said:
Thanks for confirming. The error you're seeing indicates that the legend with the name "MainLegend" does not exist or isn't being found by the script at runtime. ‚úÖ Fix the legend reference safely:
To prevent the IndexError, we‚Äôll update the script to search for the legend element by name and fail gracefully if it's not found. Here's the corrected section of your script:

üîß Replace this line:
legend = layout.listElements("LEGEND_ELEMENT", "MainLegend")[0]
‚úÖ With this safer version:
legend_list = layout.listElements("LEGEND_ELEMENT", "MainLegend")
if not legend_list:
    raise ValueError("Legend named 'MainLegend' not found in layout.") legend = legend_list[0]
This change checks if a legend named "MainLegend" exists before trying to access it. If not, it will raise a clear and user-friendly error. Once you apply that fix, rerun the script and let me know how the layout looks. Would you like me to update the full script in the project with this fix for you? You said:
Updated script:

import arcpy
import pandas as pd
from datetime import datetime
import os

# Set paths
csv_path = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\DateRelated\7Day_28Day_Cycle_20250414.csv"
export_root = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports"
project = arcpy.mp.ArcGISProject("CURRENT")
map_obj = project.listMaps()[0]  # Assumes one map in project

# Load cycle control table
cycle_df = pd.read_csv(csv_path)
if not any(cycle_df['Is_Due'] == True):
    raise ValueError("No cycle is marked as 'Is_Due = True' in the cycle table.") current_cycle = cycle_df[cycle_df['Is_Due'] == True].iloc[0]

# Extract dates and naming info
seven_day_start = pd.to_datetime(current_cycle['7_Day_Start']).strftime('%Y-%m-%d')
seven_day_end = pd.to_datetime(current_cycle['7_Day_End']).strftime('%Y-%m-%d')
twenty_eight_day_start = pd.to_datetime(current_cycle['28_Day_Start']).strftime('%Y-%m-%d')
twenty_eight_day_end = pd.to_datetime(current_cycle['28_Day_End']).strftime('%Y-%m-%d')
ytd_start = '2024-12-31'
report_name = current_cycle['Report_Name']
report_due_date = pd.to_datetime(current_cycle['Report_Due_Date']).strftime('%Y_%m_%d')

# Output folder
report_folder = os.path.join(export_root, f"{report_name}_{report_due_date}")
os.makedirs(report_folder, exist_ok=True)

# Keyword filters
keywords_by_crime = {
    "Burglary - Auto": ['auto'],
    "Burglary - Comm & Res": ['residence', 'commercial'],
    "Robbery": ['robbery'],
    "Sexual Offenses": ['sexual'],
    "MV Theft": ['motor vehicle theft']
}

# SQL definition builders
def build_sql(start_date, end_date, keywords):
    clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return f"calldate >= date '{start_date}' AND calldate <= date '{end_date}' AND disposition LIKE '%report%' AND ({clause})"

def build_sql_ytd(keywords):
    clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return f"calldate >= date '{ytd_start}' AND disposition LIKE '%report%' AND ({clause})"

# Apply queries
layer_query_mapping = {}
for crime, keywords in keywords_by_crime.items():
    layer_query_mapping[f"{crime} 7-Day"] = build_sql(seven_day_start, seven_day_end, keywords)
    layer_query_mapping[f"{crime} 28-Day"] = build_sql(twenty_eight_day_start, twenty_eight_day_end, keywords)
    layer_query_mapping[f"{crime} YTD"] = build_sql_ytd(keywords)

for lname, sql in layer_query_mapping.items():
    lyr = map_obj.listLayers(lname)[0]
    lyr.definitionQuery = sql

layout = [lyt for lyt in project.listLayouts() if lyt.name.lower().startswith("crime_reporting_layout")][0]
legend_list = layout.listElements("LEGEND_ELEMENT", "MainLegend")
if not legend_list:
    raise ValueError("Legend named 'MainLegend' not found in layout.") legend = legend_list[0]
  # Match updated legend name

crime_types = list(keywords_by_crime.keys())
base_layers = [
    "City Boundaries",
    "Human Geography Dark Label",
    "Human Geography Dark Detail",
    "Human Geography Dark Base"
]

for crime in crime_types:
    visible_layers = []
    for lyr in map_obj.listLayers():
        if crime in lyr.name:
            lyr.visible = True
            visible_layers.append(lyr)
            if "7-Day" in lyr.name:
                lyr.transparency = 0
            else:
                lyr.transparency = 60
        elif any(base in lyr.name for base in base_layers):
            lyr.visible = True
        else:
            lyr.visible = False

    # Zoom using extent of all visible features
    extent = None
    for lyr in visible_layers:
        if lyr.supports("DATASOURCE"):
            with arcpy.da.SearchCursor(lyr, ["SHAPE@"]) as cursor:
                for row in cursor:
                    geom = row[0]
                    if extent:
                        extent = arcpy.Extent(
                            min(extent.XMin, geom.extent.XMin),
                            min(extent.YMin, geom.extent.YMin),
                            max(extent.XMax, geom.extent.XMax),
                            max(extent.YMax, geom.extent.YMax)
                        )
                    else:
                        extent = geom.extent
    if extent:
        map_obj.defaultCamera.setExtent(extent)

    # Export
    output_pdf = os.path.join(report_folder, f"{crime.replace(' ', '_')}_{report_name}_{report_due_date}.pdf")
    layout.exportToPDF(output_pdf)

arcpy.AddMessage(f"Reports exported to: {report_folder}")

Returned this error:

ScriptWeekly Crime Report
=====================
Tool Path

C:\GIS_Tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Sunday, May 4, 2025 4:00:48 PM
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\Code\Python\weekly_crime_report.py", line 63, in <module>
Ôªø    raise ValueError("Legend named 'MainLegend' not found in layout.") ÔªøValueError: Legend named 'MainLegend' not found in layout. Failed script ScriptWeekly Crime Report...
Failed to execute (WeeklyCrimeReport). Failed at Sunday, May 4, 2025 4:00:51 PM (Elapsed Time: 3.37 seconds)
ChatGPT said:
Thanks for sharing the full script and the latest error. The error you're encountering:

IndexError: list index out of range
Legend named 'MainLegend' not found in layout. means that ArcGIS Pro cannot find a legend element with the exact name "MainLegend" in the layout. Here's how to fix it:

‚úÖ Fix: Identify and Correct the Legend Element Name
Option 1: Check Legend Name in the Layout
In ArcGIS Pro, open the Layout View. In the Contents pane, locate the legend item. Right-click the legend and select Properties. Under the Name field at the top, ensure the name is exactly:

MainLegend
(Case-sensitive, no extra spaces.) Option 2: Fallback to First Legend if Name Not Found
To make the script more resilient, you can modify this block in your script:

legend_list = layout.listElements("LEGEND_ELEMENT", "MainLegend")
if not legend_list:
    raise ValueError("Legend named 'MainLegend' not found in layout.") legend = legend_list[0]
‚úÖ Replace it with this:
legend_list = layout.listElements("LEGEND_ELEMENT")
if not legend_list:
    raise ValueError("No legend element found in the layout.") legend = next((l for l in legend_list if l.name == "MainLegend"), legend_list[0])
This will:

Use "MainLegend" if found. Otherwise, fall back to the first available legend. Once you confirm or correct the legend name in your layout, rerun the script. Would you like me to update this part in the script for you now? You said:
name was confirmed, project and script in folder was updated to:

import arcpy
import pandas as pd
from datetime import datetime
import os

# Set paths
csv_path = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\DateRelated\7Day_28Day_Cycle_20250414.csv"
export_root = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports"
project = arcpy.mp.ArcGISProject("CURRENT")
map_obj = project.listMaps()[0]  # Assumes one map in project

# Load cycle control table
cycle_df = pd.read_csv(csv_path)
if not any(cycle_df['Is_Due'] == True):
    raise ValueError("No cycle is marked as 'Is_Due = True' in the cycle table.") current_cycle = cycle_df[cycle_df['Is_Due'] == True].iloc[0]

# Extract dates and naming info
seven_day_start = pd.to_datetime(current_cycle['7_Day_Start']).strftime('%Y-%m-%d')
seven_day_end = pd.to_datetime(current_cycle['7_Day_End']).strftime('%Y-%m-%d')
twenty_eight_day_start = pd.to_datetime(current_cycle['28_Day_Start']).strftime('%Y-%m-%d')
twenty_eight_day_end = pd.to_datetime(current_cycle['28_Day_End']).strftime('%Y-%m-%d')
ytd_start = '2024-12-31'
report_name = current_cycle['Report_Name']
report_due_date = pd.to_datetime(current_cycle['Report_Due_Date']).strftime('%Y_%m_%d')

# Output folder
report_folder = os.path.join(export_root, f"{report_name}_{report_due_date}")
os.makedirs(report_folder, exist_ok=True)

# Keyword filters
keywords_by_crime = {
    "Burglary - Auto": ['auto'],
    "Burglary - Comm & Res": ['residence', 'commercial'],
    "Robbery": ['robbery'],
    "Sexual Offenses": ['sexual'],
    "MV Theft": ['motor vehicle theft']
}

# SQL definition builders
def build_sql(start_date, end_date, keywords):
    clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return f"calldate >= date '{start_date}' AND calldate <= date '{end_date}' AND disposition LIKE '%report%' AND ({clause})"

def build_sql_ytd(keywords):
    clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return f"calldate >= date '{ytd_start}' AND disposition LIKE '%report%' AND ({clause})"

# Apply queries
layer_query_mapping = {}
for crime, keywords in keywords_by_crime.items():
    layer_query_mapping[f"{crime} 7-Day"] = build_sql(seven_day_start, seven_day_end, keywords)
    layer_query_mapping[f"{crime} 28-Day"] = build_sql(twenty_eight_day_start, twenty_eight_day_end, keywords)
    layer_query_mapping[f"{crime} YTD"] = build_sql_ytd(keywords)

for lname, sql in layer_query_mapping.items():
    lyr = map_obj.listLayers(lname)[0]
    lyr.definitionQuery = sql

layout = [lyt for lyt in project.listLayouts() if lyt.name.lower().startswith("crime_reporting_layout")][0]
legend_list = layout.listElements("LEGEND_ELEMENT")
if not legend_list:
    raise ValueError("No legend element found in the layout.") legend = next((l for l in legend_list if l.name == "MainLegend"), legend_list[0])

  # Match updated legend name

crime_types = list(keywords_by_crime.keys())
base_layers = [
    "City Boundaries",
    "Human Geography Dark Label",
    "Human Geography Dark Detail",
    "Human Geography Dark Base"
]

for crime in crime_types:
    visible_layers = []
    for lyr in map_obj.listLayers():
        if crime in lyr.name:
            lyr.visible = True
            visible_layers.append(lyr)
            if "7-Day" in lyr.name:
                lyr.transparency = 0
            else:
                lyr.transparency = 60
        elif any(base in lyr.name for base in base_layers):
            lyr.visible = True
        else:
            lyr.visible = False

    # Zoom using extent of all visible features
    extent = None
    for lyr in visible_layers:
        if lyr.supports("DATASOURCE"):
            with arcpy.da.SearchCursor(lyr, ["SHAPE@"]) as cursor:
                for row in cursor:
                    geom = row[0]
                    if extent:
                        extent = arcpy.Extent(
                            min(extent.XMin, geom.extent.XMin),
                            min(extent.YMin, geom.extent.YMin),
                            max(extent.XMax, geom.extent.XMax),
                            max(extent.YMax, geom.extent.YMax)
                        )
                    else:
                        extent = geom.extent
    if extent:
        map_obj.defaultCamera.setExtent(extent)

    # Export
    output_pdf = os.path.join(report_folder, f"{crime.replace(' ', '_')}_{report_name}_{report_due_date}.pdf")
    layout.exportToPDF(output_pdf)

arcpy.AddMessage(f"Reports exported to: {report_folder}")
ChatGPT said:
Thanks for confirming and posting the updated script. Everything looks well-structured now, with proper fallback for the legend and correct extent calculation. Here are a few final recommendations and checkpoints to ensure the layout fully exports correctly with the legend:

‚úÖ Checklist: Ensure Layout and Legend Work as Expected
Legend Name in Layout:

Confirm it's exactly MainLegend (case-sensitive, no extra spaces). If not sure, rename it in the Layout‚Äôs Contents pane in ArcGIS Pro. Legend Settings:

Set to manual mode (uncheck Auto-update). Initially, include at least one visible layer in the legend so it's not empty. Map Frame Connection:

Make sure the legend is tied to the correct map frame in the layout (right-click legend ‚Üí Properties ‚Üí Map Frame). Rebuild Test:

If you made recent layout changes, save the project before running the script. Then run the script from the project (not a detached or unsaved copy). ‚ùìIf Layout Still Fails:
If the legend still doesn‚Äôt appear or the script crashes again, I can show you how to dynamically delete and insert a fresh legend tied to the current map frame‚Äîprogrammatically. This has worked as a fallback in similar automation scenarios. Would you like to proceed with that dynamic legend creation method if the static layout fails again? You said:
ScriptWeekly Crime Report
=====================
Tool Path

C:\GIS_Tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Sunday, May 4, 2025 4:06:11 PM

I got this error 
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\Code\Python\weekly_crime_report.py", line 63, in <module>
Ôªø    raise ValueError("No legend element found in the layout.") ÔªøValueError: No legend element found in the layout. Failed script ScriptWeekly Crime Report...
Failed to execute (WeeklyCrimeReport). Failed at Sunday, May 4, 2025 4:06:16 PM (Elapsed Time: 4.42 seconds)
how can we address this error? ChatGPT said:
The error:

ValueError: No legend element found in the layout. means that no legend element was detected in your layout when the script attempted to list them using:

layout.listElements("LEGEND_ELEMENT")
‚úÖ To resolve this:
Verify the Layout Has a Legend

Open the template project. Go to your layout named Crime_Reporting_Layout... If there's no legend in the Contents pane, add one:

Insert ‚Üí Legend

Drag it into the layout. Rename it in the Contents pane to: MainLegend (make sure there are no leading/trailing spaces and capitalization matches exactly). Save the project to lock in the layout change. Re-run the script. ‚úÖ Optional Script Adjustment for Robustness
If you want the script to fail more gracefully, you can replace:

legend_list = layout.listElements("LEGEND_ELEMENT")
if not legend_list:
    raise ValueError("No legend element found in the layout.") with something safer:

legend_list = layout.listElements("LEGEND_ELEMENT", "MainLegend")
if not legend_list:
    arcpy.AddWarning("Legend named 'MainLegend' not found. Skipping legend update.") else:
    legend = legend_list[0]
Would you like me to update the script in the canvas to include that safer version? You said:
Uploaded image
ChatGPT said:
Thanks for confirming. Based on your screenshot and the fact that the script still raises ValueError: No legend element found in the layout, I can confirm the issue is due to a mismatch between the layout context and the element listing method. Your legend named MainLegend exists within a layout named Crime Report Legend, and it's associated with a Map Frame (not directly the layout itself). Here's how to correctly target the legend within the correct layout context:

‚úÖ Fix: Update layout name filter and search for the legend within a MAPSURROUND_ELEMENT context
Update this part of your script:

layout = [lyt for lyt in project.listLayouts() if lyt.name.lower().startswith("crime_reporting_layout")][0]
legend_list = layout.listElements("LEGEND_ELEMENT")
üîß Replace it with:
layout = [lyt for lyt in project.listLayouts() if lyt.name == "Crime Report Legend"][0]
legend_list = layout.listElements("MAPSURROUND_ELEMENT", "MainLegend")
if not legend_list:
    raise ValueError("Legend element 'MainLegend' not found in layout.") legend = legend_list[0]
MAPSURROUND_ELEMENT is the correct element type for legends in layout views. Once you make this change and re-run the script, the legend should be located properly, and the script should continue to layout export without raising that error. Would you like me to apply this fix directly in the code for you? You said:
received this error:

ScriptWeekly Crime Report
=====================
Tool Path

C:\GIS_Tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Sunday, May 4, 2025 4:16:08 PM
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\Code\Python\weekly_crime_report.py", line 63, in <module>
Ôªø    raise ValueError("Legend element 'MainLegend' not found in layout.") ÔªøValueError: Legend element 'MainLegend' not found in layout. Failed script ScriptWeekly Crime Report...
Failed to execute (WeeklyCrimeReport). Failed at Sunday, May 4, 2025 4:16:12 PM (Elapsed Time: 3.57 seconds)

updated code:

import arcpy
import pandas as pd
from datetime import datetime
import os

# Set paths
csv_path = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\DateRelated\7Day_28Day_Cycle_20250414.csv"
export_root = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports"
project = arcpy.mp.ArcGISProject("CURRENT")
map_obj = project.listMaps()[0]  # Assumes one map in project

# Load cycle control table
cycle_df = pd.read_csv(csv_path)
if not any(cycle_df['Is_Due'] == True):
    raise ValueError("No cycle is marked as 'Is_Due = True' in the cycle table.") current_cycle = cycle_df[cycle_df['Is_Due'] == True].iloc[0]

# Extract dates and naming info
seven_day_start = pd.to_datetime(current_cycle['7_Day_Start']).strftime('%Y-%m-%d')
seven_day_end = pd.to_datetime(current_cycle['7_Day_End']).strftime('%Y-%m-%d')
twenty_eight_day_start = pd.to_datetime(current_cycle['28_Day_Start']).strftime('%Y-%m-%d')
twenty_eight_day_end = pd.to_datetime(current_cycle['28_Day_End']).strftime('%Y-%m-%d')
ytd_start = '2024-12-31'
report_name = current_cycle['Report_Name']
report_due_date = pd.to_datetime(current_cycle['Report_Due_Date']).strftime('%Y_%m_%d')

# Output folder
report_folder = os.path.join(export_root, f"{report_name}_{report_due_date}")
os.makedirs(report_folder, exist_ok=True)

# Keyword filters
keywords_by_crime = {
    "Burglary - Auto": ['auto'],
    "Burglary - Comm & Res": ['residence', 'commercial'],
    "Robbery": ['robbery'],
    "Sexual Offenses": ['sexual'],
    "MV Theft": ['motor vehicle theft']
}

# SQL definition builders
def build_sql(start_date, end_date, keywords):
    clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return f"calldate >= date '{start_date}' AND calldate <= date '{end_date}' AND disposition LIKE '%report%' AND ({clause})"

def build_sql_ytd(keywords):
    clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return f"calldate >= date '{ytd_start}' AND disposition LIKE '%report%' AND ({clause})"

# Apply queries
layer_query_mapping = {}
for crime, keywords in keywords_by_crime.items():
    layer_query_mapping[f"{crime} 7-Day"] = build_sql(seven_day_start, seven_day_end, keywords)
    layer_query_mapping[f"{crime} 28-Day"] = build_sql(twenty_eight_day_start, twenty_eight_day_end, keywords)
    layer_query_mapping[f"{crime} YTD"] = build_sql_ytd(keywords)

for lname, sql in layer_query_mapping.items():
    lyr = map_obj.listLayers(lname)[0]
    lyr.definitionQuery = sql

layout = [lyt for lyt in project.listLayouts() if lyt.name == "Crime Report Legend"][0]
legend_list = layout.listElements("MAPSURROUND_ELEMENT", "MainLegend")
if not legend_list:
    raise ValueError("Legend element 'MainLegend' not found in layout.") legend = legend_list[0]

if not legend_list:
    raise ValueError("No legend element found in the layout.") legend = next((l for l in legend_list if l.name == "MainLegend"), legend_list[0])

  # Match updated legend name

crime_types = list(keywords_by_crime.keys())
base_layers = [
    "City Boundaries",
    "Human Geography Dark Label",
    "Human Geography Dark Detail",
    "Human Geography Dark Base"
]

for crime in crime_types:
    visible_layers = []
    for lyr in map_obj.listLayers():
        if crime in lyr.name:
            lyr.visible = True
            visible_layers.append(lyr)
            if "7-Day" in lyr.name:
                lyr.transparency = 0
            else:
                lyr.transparency = 60
        elif any(base in lyr.name for base in base_layers):
            lyr.visible = True
        else:
            lyr.visible = False

    # Zoom using extent of all visible features
    extent = None
    for lyr in visible_layers:
        if lyr.supports("DATASOURCE"):
            with arcpy.da.SearchCursor(lyr, ["SHAPE@"]) as cursor:
                for row in cursor:
                    geom = row[0]
                    if extent:
                        extent = arcpy.Extent(
                            min(extent.XMin, geom.extent.XMin),
                            min(extent.YMin, geom.extent.YMin),
                            max(extent.XMax, geom.extent.XMax),
                            max(extent.YMax, geom.extent.YMax)
                        )
                    else:
                        extent = geom.extent
    if extent:
        map_obj.defaultCamera.setExtent(extent)

    # Export
    output_pdf = os.path.join(report_folder, f"{crime.replace(' ', '_')}_{report_name}_{report_due_date}.pdf")
    layout.exportToPDF(output_pdf)

arcpy.AddMessage(f"Reports exported to: {report_folder}")
ChatGPT said:
The script is now corrected to check for the MainLegend within "MAPSURROUND_ELEMENT" elements without causing an error if not found. If the legend named "MainLegend" is not found, it raises a clear error. You can now re-run the script to test the updated logic. Let me know if the export works this time or if the legend still fails to populate. Provide Feedback | View Changes | Contribute. You said:
import arcpy
import pandas as pd
from datetime import datetime
import os

# Set paths
csv_path = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\DateRelated\7Day_28Day_Cycle_20250414.csv"
export_root = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports"
project = arcpy.mp.ArcGISProject("CURRENT")
map_obj = project.listMaps()[0]  # Assumes one map in project

# Load cycle control table
cycle_df = pd.read_csv(csv_path)
if not any(cycle_df['Is_Due'] == True):
    raise ValueError("No cycle is marked as 'Is_Due = True' in the cycle table.") current_cycle = cycle_df[cycle_df['Is_Due'] == True].iloc[0]

# Extract dates and naming info
seven_day_start = pd.to_datetime(current_cycle['7_Day_Start']).strftime('%Y-%m-%d')
seven_day_end = pd.to_datetime(current_cycle['7_Day_End']).strftime('%Y-%m-%d')
twenty_eight_day_start = pd.to_datetime(current_cycle['28_Day_Start']).strftime('%Y-%m-%d')
twenty_eight_day_end = pd.to_datetime(current_cycle['28_Day_End']).strftime('%Y-%m-%d')
ytd_start = '2024-12-31'
report_name = current_cycle['Report_Name']
report_due_date = pd.to_datetime(current_cycle['Report_Due_Date']).strftime('%Y_%m_%d')

# Output folder
report_folder = os.path.join(export_root, f"{report_name}_{report_due_date}")
os.makedirs(report_folder, exist_ok=True)

# Keyword filters
keywords_by_crime = {
    "Burglary - Auto": ['auto'],
    "Burglary - Comm & Res": ['residence', 'commercial'],
    "Robbery": ['robbery'],
    "Sexual Offenses": ['sexual'],
    "MV Theft": ['motor vehicle theft']
}

# SQL definition builders
def build_sql(start_date, end_date, keywords):
    clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return f"calldate >= date '{start_date}' AND calldate <= date '{end_date}' AND disposition LIKE '%report%' AND ({clause})"

def build_sql_ytd(keywords):
    clause = " OR ".join([f"calltype LIKE '%{kw}%'" for kw in keywords])
    return f"calldate >= date '{ytd_start}' AND disposition LIKE '%report%' AND ({clause})"

# Apply queries
layer_query_mapping = {}
for crime, keywords in keywords_by_crime.items():
    layer_query_mapping[f"{crime} 7-Day"] = build_sql(seven_day_start, seven_day_end, keywords)
    layer_query_mapping[f"{crime} 28-Day"] = build_sql(twenty_eight_day_start, twenty_eight_day_end, keywords)
    layer_query_mapping[f"{crime} YTD"] = build_sql_ytd(keywords)

for lname, sql in layer_query_mapping.items():
    lyr = map_obj.listLayers(lname)[0]
    lyr.definitionQuery = sql

layout = [lyt for lyt in project.listLayouts() if lyt.name == "Crime Report Legend"][0]
legend_list = layout.listElements("MAPSURROUND_ELEMENT")
legend = next((l for l in legend_list if l.name == "MainLegend"), None)
if legend is None:
    raise ValueError("Legend element 'MainLegend' not found in layout.") crime_types = list(keywords_by_crime.keys())
base_layers = [
    "City Boundaries",
    "Human Geography Dark Label",
    "Human Geography Dark Detail",
    "Human Geography Dark Base"
]

for crime in crime_types:
    visible_layers = []
    for lyr in map_obj.listLayers():
        if crime in lyr.name:
            lyr.visible = True
            visible_layers.append(lyr)
            if "7-Day" in lyr.name:
                lyr.transparency = 0
            else:
                lyr.transparency = 60
        elif any(base in lyr.name for base in base_layers):
            lyr.visible = True
        else:
            lyr.visible = False

    # Zoom using extent of all visible features
    extent = None
    for lyr in visible_layers:
        if lyr.supports("DATASOURCE"):
            with arcpy.da.SearchCursor(lyr, ["SHAPE@"]) as cursor:
                for row in cursor:
                    geom = row[0]
                    if extent:
                        extent = arcpy.Extent(
                            min(extent.XMin, geom.extent.XMin),
                            min(extent.YMin, geom.extent.YMin),
                            max(extent.XMax, geom.extent.XMax),
                            max(extent.YMax, geom.extent.YMax)
                        )
                    else:
                        extent = geom.extent
    if extent:
        map_obj.defaultCamera.setExtent(extent)

    # Export
    output_pdf = os.path.join(report_folder, f"{crime.replace(' ', '_')}_{report_name}_{report_due_date}.pdf")
    layout.exportToPDF(output_pdf)

arcpy.AddMessage(f"Reports exported to: {report_folder}")

This code caused this error:

ScriptWeekly Crime Report
=====================
Tool Path

C:\GIS_Tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Sunday, May 4, 2025 4:20:13 PM
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\Code\Python\weekly_crime_report.py", line 64, in <module>
Ôªø    raise ValueError("Legend element 'MainLegend' not found in layout.") ÔªøValueError: Legend element 'MainLegend' not found in layout. Failed script ScriptWeekly Crime Report...
Failed to execute (WeeklyCrimeReport). Failed at Sunday, May 4, 2025 4:20:17 PM (Elapsed Time: 3.50 seconds)
ChatGPT said:
The script is now updated to handle the legend identification more robustly. It checks all MAPSURROUND_ELEMENT elements for a name match with "MainLegend" (case-insensitive) and logs found names for clarity if not found. You can now re-run the tool. If the error persists, let me know what other legend names appear, and I can refine the logic even further. Would you like to also include a debug print of the legend names directly into the layout for easier troubleshooting? You said:
ScriptWeekly Crime Report
=====================
Tool Path

C:\GIS_Tools\CrimeAutomationTools.tbx\WeeklyCrimeReport
=====================
Parameters

=====================
Messages

Start Time: Sunday, May 4, 2025 4:24:09 PM
ÔªøTraceback (most recent call last):
Ôªø  File "C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\Refrence\TimeSCRPT\Code\Python\weekly_crime_report.py", line 71, in <module>
Ôªø    raise ValueError(f"Legend element 'MainLegend' not found in layout. Found: {legend_names}")
ÔªøValueError: Legend element 'MainLegend' not found in layout. Found: ['Scale Bar', 'North Arrow']

Failed script ScriptWeekly Crime Report...
Failed to execute (WeeklyCrimeReport). Failed at Sunday, May 4, 2025 4:24:12 PM (Elapsed Time: 3.27 seconds)

sould we add debug to the script? ChatGPT said:
The script is now updated to print out all legend element names for debugging using arcpy.AddMessage. This way, you'll see in the tool messages what legend names are actually present in your layout. Make sure:

The layout name is exactly "Crime Report Legend". The legend element is named exactly "MainLegend" (case-insensitive, but no extra spaces). You run the script inside the correct project. Let me know what the legend names show in your next test run. Provide Feedback | View Changes | Contribute.