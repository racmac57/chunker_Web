````

````plaintext
ChatGPT Chat Summary SCRPA Project 21b4484370c080138f2efc3a045a471e.md
o ArcGIS Pro project

Grok: CORRECTED 7-Day period: 2025-05-27 to 2025-06-02

Grok: Using CORRECTED timestamp dates: {'7-Day': '2025-05-27 00:00:00.000', '28-Day': '2025-05-06 00:00:00.000', 'YTD': '2025-01-01 00:00:00.000'}

Grok: Processing 7-Day data...

Grok: Found layer: Sexual Offenses 7-Day

Grok: 7-Day SQL (with end date): (calltype LIKE '%SEXUAL ASSAULT%' OR calltype LIKE '%SEXUAL OFFENSE%') And disposition LIKE '%See Report%' And calldate >= timestamp '2025-05-27 00:00:00.000' And calldate <= timestamp '2025-06-02 23:59:59.999'

Grok: 7-Day features found: 0

Grok: 7-Day time distribution: {'00:00-03:59': 0, '04:00-07:59': 0, '08:00-11:59': 0, '12:00-15:59': 0, '16:00-19:59': 0, '20:00-23:59': 0}

Grok: Processing 28-Day data...

Grok: Found layer: Sexual Offenses 28-Day

Grok: 28-Day SQL Filter: (calltype LIKE '%SEXUAL ASSAULT%' OR calltype LIKE '%SEXUAL OFFENSE%') And disposition LIKE '%See Report%' And calldate >= timestamp '2025-05-06 00:00:00.000'

Grok: 28-Day features found: 5

Grok: Processed 5 records with real time data

Grok: 28-Day time distribution: {'00:00-03:59': 0, '04:00-07:59': 0, '08:00-11:59': 2, '12:00-15:59': 2, '16:00-19:59': 0, '20:00-23:59': 1}

Grok: Processing YTD data...

Grok: Found layer: Sexual Offenses YTD

Grok: YTD SQL Filter: (calltype LIKE '%SEXUAL ASSAULT%' OR calltype LIKE '%SEXUAL OFFENSE%') And disposition LIKE '%See Report%' And calldate >= timestamp '2025-01-01 00:00:00.000'

Grok: YTD features found: 11

Grok: Processed 11 records with real time data

Grok: YTD time distribution: {'00:00-03:59': 0, '04:00-07:59': 0, '08:00-11:59': 4, '12:00-15:59': 3, '16:00-19:59': 1, '20:00-23:59': 3}

Grok: Chart saved with UNIFORM legend positioning: C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C06W23_2025_06_03_7Day\Sexual_Offenses\Sexual_Offenses_Chart.png

Grok: Final Chart Data for Sexual Offenses:

Grok: Â  7-Day: 0 incidents

Grok: Â  28-Day: 5 incidents

Grok: Â  YTD: 11 incidents

Grok: CORRECTED 7-Day period analyzed: 2025-05-27 to 2025-06-02

Grok: WARNING:root:Â  No incident table found for MV Theft

Grok: WARNING:root:Â  No incident table found for Burglary - Auto

Grok: WARNING:root:Â  No incident table found for Burglary - Comm & Res

Grok: WARNING:root:Â  No incident table found for Robbery

Grok: WARNING:root:Â  No incident table found for Sexual Offenses

Grok: Run complete. Grok: Done. Press any key to close... User: Press any key to continue . . . User: dir "C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C06W23_2025_06_03_7Day" /T:W

Grok: dir output shows:

Grok: Directory of C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C06W23_2025_06_03_7Day

Grok: 06/23/25Â  01:30

. ````

````plaintext
Complete Config.py - Final Version.txt
# ðŸ•’ 2025-06-10-21-50-00
# Police_Data_Analysis/complete_config_final
# Author: R. A. Carucci
# Purpose: Complete config.py with Excel integration and corrected paths

# =============================================================================
# IMPORTS
# =============================================================================

import os
import openpyxl
import logging
import sys
from datetime import datetime, date, timedelta

# =============================================================================
# CORRECTED PATHS BASED ON YOUR ONEDRIVE STRUCTURE
# =============================================================================

# Excel cycle file
EXCEL_CYCLE_PATH = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_Hackensack_Data_Repository\7Day_28Day_Cycle_20250414.xlsx"

# Base directory for reports
REPORT_BASE_DIR = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports"

# CORRECTED ArcGIS Pro project path - updated to actual filename
APR_PATH = r"C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\7_Day_Templet_SCRPA_Time\7_Day_Templet_SCRPA_Time_PD_BCI_LT.aprx"

# PowerPoint templates
POWERPOINT_TEMPLATES = {
    "main": r"C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\TimeSCRPATemplet\SCRPA_REPORT.pptx",
    "7day": r"C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\7_Day_Templet_SCRPA_Time\SCRPA_REPORT.pptx"
}

# Crime type to folder mapping
CRIME_FOLDER_MAPPING = {
    "MV Theft": "MV_Theft",
    "Burglary - Auto": "Burglary_Auto", 
    "Burglary - Comm & Res": "Burglary_Comm_And_Res",
    "Robbery": "Robbery",
    "Sexual Offenses": "Sexual_Offenses"
}

# Crime type SQL patterns for filtering data
CRIME_SQL_PATTERNS = {
    "MV Theft": "AUTO THEFT",
    "Burglary - Auto": "BURGLARY AUTO",
    "Burglary - Comm & Res": ["BURGLARY COMMERCIAL", "BURGLARY RESIDENTIAL"], 
    "Robbery": "ROBBERY",
    "Sexual Offenses": ["SEXUAL ASSAULT", "SEXUAL OFFENSE"]
}

# For compatibility with any existing code that might reference FOLDER_NAME_MAPPING
FO
````

````plaintext
sex off.txt
Case Number	IncidentDate	Incident Time	Incident Date_Between	Incident Time_Between	Report Date	Report Time	FullAddress	Grid	Zone	Narrative	Total Value Stolen	Total Value Recover	Registration 1	Make1	Model1	Reg State 1	Registration 2	Reg State 2	Make2	Model2	Reviewed By	CompleteCalc	Officer of Record	Squad	Det_Assigned	Case_Status	NibrsClassification	CASE_NUMBER_LENGTH	Incident Date	IncTime	StartOfHour	TimeOfDay	Block	AllIncidents	Period	ALL_INCIDENTS	INC_TIME	INC_DATE	Start of Hour	INC_DATE_AND_TIME	TOD	Day Name	Month Name	Year	Week of Year	Week of Month	Day	Day of Year	BLOCK	Location	St#	Notes	VEHICLE	Suspect	TOTAL_STOLEN_AMOUNT	REPORT_CYCLE	TIME_OF_DAY	Enhanced_TimeOfDay	Attribute	Incident_Type
25-002564	1/7/2025	2:00:00 PM	null	null	1/10/2025	2:20:51 PM	135 First Street, Hackensack, NJ, 07601	G3	7	On Friday January 10, 2025, I was assigned as the Hackensack High School SRO. I was advised that a student wanted to report a crime and was currently in the main office. Upon arriving to the main office I met the victim, A.R. As I began to speak with the victim she immediately began to cry. She stated that she was inappropriately touched by the suspect who is also student. The suspect was identified as Manuel Martinez Perez. The victim stated that on Tuesday January 7, 2025  she was in her 9th period class ESL 2 in room 276. She shares this class with the suspect and his cousin Esmeralda Perez Martinez who is a potential witness. The victim stated during class the suspect gave her a hug. As he was hugging her he dropped his hand down and grabbed her breast over her clothing. She immediately became angry and told him not to touch her. She then advised Esmeralda Perez Martinez that she was touched inappropriately by the suspect. The victim stated that she reported this incident to her her teacher...	null	null	null	null	null	null	null	null	null	null	Dominguez_l	Complete	Det. Cristobal Lara-Nunez 341	STA	Det. Evelyn Reyes 336	Active/Administratively Closed	11D = Fondling	9	1/7/2025	2:00:00 PM	2:00:00 PM	Afternoon (12:00â€“15:59)	First Street, 100 Block	Criminal Sexual Contact - 2C:14-3a - Juvenile Investigation	YTD	Criminal Sexual Contact - 2C:14-3a - Juvenile Investigation	2:00:00 PM	1/7/2025	2:00:00 PM	null	Afternoon (12:00â€“15:59)	Tuesday	January	2025	2	2	7	7	First Street, 100 Block	135 First Street, Hackensack, NJ, 07601	null	null	null	null	null	null	Afternoon (12:00â€“15:59)	Afternoon (12:00â€“15:59)	Incident Type_1	Criminal Sexual Contact - 2C:14-3a
25-006324	1/23/2025	3:00:00 PM	null	null	1/23/2025	3:58:15 PM	176  Berdan Place, Hackensack, NJ, 07601	H3	8	On Thursday, 01/23/2025 I was notified by D/Sgt. Dominguez of a possible sexual assault involving a juvenile. I was advised that 10 y/o S.S. disclosed to a school teacher that her mothers boyfriend has been touching her while her mother was sleeping. This reportedly has occurred on multiple occasions. No further information was available at this time. S.S.
````

````plaintext
config.py
# If it is truly optional and not needed for your workflow, set this to None
# to prevent the "NOT FOUND (optional)" warning. PROCESSED_EXCEL_PATH: Union[str, None] = os.path.join(USER_HOME, r"OneDrive - City of Hackensack\_Hackensack_Data_Repository\Processed_SCRPA_Data.xlsx")
# Example if not needed: PROCESSED_EXCEL_PATH = None

# Laptop-specific paths
REPORT_BASE_DIR = os.path.join(LAPTOP_ROOT, "temp_reports")
# UPDATED APR_PATH TO NEW USER-PROVIDED PATH
APR_PATH = r"C:\Users\carucci_r\SCRPA_LAPTOP\projects\7_Day_Templet_SCRPA_Time_PD_BCI_LTP.aprx"

# PowerPoint templates - OneDrive should sync to same location
POWERPOINT_TEMPLATES = {
    "main": os.path.join(USER_HOME, r"OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\TimeSCRPATemplet\SCRPA_REPORT.pptx"),
    "7day": os.path.join(USER_HOME, r"OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\7_Day_Templet_SCRPA_Time\SCRPA_REPORT.pptx")
}

# ArcGIS settings
CITY_BOUNDARIES_LAYER_NAME = "City Boundaries"

# Crime types and folder mapping
CRIME_FOLDER_MAPPING = {
    "MV Theft": "MV_Theft",
    "Burglary - Auto": "Burglary_Auto", # <<< FIXED TYPO HERE: Burglury -> Burglary
    "Burglary - Comm & Res": "Burglary_Comm_And_Res",
    "Robbery": "Robbery",
    "Sexual Offenses": "Sexual_Offenses"
}

# SQL patterns - 'CORRECTED' implies previous versions might have had issues. # Ensure these patterns accurately reflect the data field values. CRIME_SQL_PATTERNS = {
    "MV Theft": "MOTOR VEHICLE THEFT",
    "Burglary - Auto": "BURGLARY AUTO",
    "Burglary - Comm & Res": ["BURGLARY COMMERCIAL", "BURGLARY RESIDENTIAL"],
    "Robbery": "ROBBERY",
    "Sexual Offenses": ["SEXUAL ASSAULT", "SEXUAL OFFENSE"]
}

# For compatibility (aliases)
FOLDER_NAME_MAPPING = CRIME_FOLDER_MAPPING
CRIME_TYPES = list(CRIME_FOLDER_MAPPING.keys())

# Optional settings
SYM_LAYER_PATH = "" # Path to symbology layer file if used
SUFFIXES = ["7-Day", "28-Day", "YTD"]

# PowerPoint positioning coordinates - Consider making these configurable externally
# if they are subject to frequent changes, e.g., in a JSON/YAML file. ````

````plaintext
sex off.txt
Case Number	IncidentDate	Incident Time	Incident Date_Between	Incident Time_Between	Report Date	Report Time	FullAddress	Grid	Zone	Narrative	Total Value Stolen	Total Value Recover	Registration 1	Make1	Model1	Reg State 1	Registration 2	Reg State 2	Make2	Model2	Reviewed By	CompleteCalc	Officer of Record	Squad	Det_Assigned	Case_Status	NibrsClassification	CASE_NUMBER_LENGTH	Incident Date	IncTime	StartOfHour	TimeOfDay	Block	AllIncidents	Period	ALL_INCIDENTS	INC_TIME	INC_DATE	Start of Hour	INC_DATE_AND_TIME	TOD	Day Name	Month Name	Year	Week of Year	Week of Month	Day	Day of Year	BLOCK	Location	St#	Notes	VEHICLE	Suspect	TOTAL_STOLEN_AMOUNT	REPORT_CYCLE	TIME_OF_DAY	Enhanced_TimeOfDay	Attribute	Incident_Type
25-002564	1/7/2025	2:00:00 PM	null	null	1/10/2025	2:20:51 PM	135 First Street, Hackensack, NJ, 07601	G3	7	On Friday January 10, 2025, I was assigned as the Hackensack High School SRO. I was advised that a student wanted to report a crime and was currently in the main office. Upon arriving to the main office I met the victim, A.R. As I began to speak with the victim she immediately began to cry. She stated that she was inappropriately touched by the suspect who is also student. The suspect was identified as Manuel Martinez Perez. The victim stated that on Tuesday January 7, 2025  she was in her 9th period class ESL 2 in room 276. She shares this class with the suspect and his cousin Esmeralda Perez Martinez who is a potential witness. The victim stated during class the suspect gave her a hug. As he was hugging her he dropped his hand down and grabbed her breast over her clothing. She immediately became angry and told him not to touch her. She then advised Esmeralda Perez Martinez that she was touched inappropriately by the suspect. The victim stated that she reported this incident to her her teacher...	null	null	null	null	null	null	null	null	null	null	Dominguez_l	Complete	Det. Cristobal Lara-Nunez 341	STA	Det. Evelyn Reyes 336	Active/Administratively Closed	11D = Fondling	9	1/7/2025	2:00:00 PM	2:00:00 PM	Afternoon (12:00â€“15:59)	First Street, 100 Block	Criminal Sexual Contact - 2C:14-3a - Juvenile Investigation	YTD	Criminal Sexual Contact - 2C:14-3a - Juvenile Investigation	2:00:00 PM	1/7/2025	2:00:00 PM	null	Afternoon (12:00â€“15:59)	Tuesday	January	2025	2	2	7	7	First Street, 100 Block	135 First Street, Hackensack, NJ, 07601	null	null	null	null	null	null	Afternoon (12:00â€“15:59)	Afternoon (12:00â€“15:59)	Incident Type_1	Criminal Sexual Contact - 2C:14-3a
25-006324	1/23/2025	3:00:00 PM	null	null	1/23/2025	3:58:15 PM	176  Berdan Place, Hackensack, NJ, 07601	H3	8	On Thursday, 01/23/2025 I was notified by D/Sgt. Dominguez of a possible sexual assault involving a juvenile. I was advised that 10 y/o S.S. disclosed to a school teacher that her mothers boyfriend has been touching her while her mother was sleeping. This reportedly has occurred on multiple occasions. No further information was available at this time. S.S.
````

````plaintext
ChatGPT Chat Summary SCRPA Project 21b4484370c080138f2efc3a045a471e.md
Grok: Done. Press any key to close... User: Press any key to continue . . . User: dir "C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C06W23_2025_06_03_7Day" /T:W

Grok: dir output shows:

Grok: Directory of C:\Users\carucci_r\OneDrive - City of Hackensack\_25_SCRPA\TIME_Based\Reports\C06W23_2025_06_03_7Day

Grok: 06/23/25Â  01:30

. Grok: 06/23/25Â  01:37

..

Grok: 06/23/25Â  03:40

Burglary_Auto

Grok: 06/23/25Â  03:40

Burglary_Comm_And_Res

Grok: 06/23/25Â  03:40 Â  Â  Â  Â  5,333,732 C06W23_2025_06_03_7Day.pptx

Grok: 06/23/25Â  03:39

MV_Theft

Grok: 06/23/25Â  03:40

Robbery

Grok: 06/23/25Â  03:40

Sexual_Offenses

Grok:Â  Â  Â  Â  Â  Â  Â  Â  1 File(s)Â  Â  Â  5,333,732 bytes

Grok:Â  Â  Â  Â  Â  Â  Â  Â  7 Dir(s)Â  516,584,435,712 bytes free

**Structured Markdown Summary (.md)**

# **SCRPA Report Generation Session**

# **Conversation Outline**

**âœ… Topics Covered**

- **Date Input Handling**: Normalized 2025_06_03, supports today, yesterday, tomorrow. - **ArcGIS Python Setup**: Hardcoded path to arcgispro-py3 Python environment. - **Main Script Execution**: Ran main.py with parameters true true false 30 false 2025_06_03. - **Chart Generation**: Successfully generated charts for MV Theft, Burglary (Auto, Comm & Res), Robbery, Sexual Offenses. - **Incident Table Warnings**: No incident tables found for all crime types (non-blocking). - **Timestamp Discrepancy**: Investigated folder modified time (01:30) vs. actual file times (03:39â€“03:40). **ðŸ§  Final Working Code(s)**

- **Batch Script (run_report_hardcoded.bat)**: Executes main.py with robust logging and runtime tracking. **Code ID**: CODE_20250623_001
- **Python Script (main.py)**: Generates crime reports and PowerPoint slides. **Code ID**: CODE_20250623_002
- **Python Script (chart_export.py)**: Generates charts with ArcPy and Excel integration. **Code ID**: CODE_20250623_003

**ðŸ” What Worked**

- Fixed Unicode emoji issues in chart_export.py to prevent UnicodeEncodeError. - Hardcoded ArcGIS Pro Python path resolved environment detection issues. - Auto-detected main.py path correctly. - Generated all charts and saved to OneDrive folder. - Logged runtime and status to run.log and runtime_log.csv. **âš ï¸ Still Unresolved**

- **Folder Timestamp Mismatch**: Parent folder shows 01:30, while contents modified at 03:39â€“03:40 (likely OneDrive sync delay). - **Incident Table Warnings**: No .csv tables generated for any crime type (expected behavior?). **ðŸ”„ Next Steps**

- Confirm if incident table warnings require table generation or are by design. - Optionally add script to update folder timestamps to match latest file. - Consider zipping project files for distribution. **ðŸ§° Tools/Tech Used**

- **Batch**: Windows Command Script for automation. - **Python**: ArcPy, matplotlib, Excel integration. - **ArcGIS Pro**: GIS data processing and chart generation. - **PowerShell**: Used for file searching and date parsing. - **OneDrive**: Report storage and syncing. ````

````plaintext
sex off.txt
When the father entered the home, he found the victim with his pants on backwards. The victim's mother stated that the father observed the suspect C.L., the victim's 13 year old uncle to be nervous. The victim told his parents that while he was with his uncle, his uncle used his penis to touch the victim's buttocks. As the victims father tried to ascertain information from the victim, he struck the victim with a belt on the back of his leg causing pain and marks of redness on the victim. ...	null	null	null	null	null	null	null	null	null	null	farhi_b	Complete	P.O. Eric Badalyan 382	A3	Det. Cristobal Lara-Nunez 341	TOT DCP&P	null	9	7/3/2025	3:00:00 PM	3:00:00 PM	Afternoon (12:00â€“15:59)	Beech Street, 200 Block	Sexual Assault - 2C:14-2b - Juvenile Investigation	28-Day	Sexual Assault - 2C:14-2b - Juvenile Investigation	3:00:00 PM	7/3/2025	3:00:00 PM	null	Afternoon (12:00â€“15:59)	Thursday	July	2025	27	1	3	184	Beech Street, 200 Block	275 Beech Street, Hackensack, NJ, 07601	null	null	null	null	null	null	Afternoon (12:00â€“15:59)	Afternoon (12:00â€“15:59)	Incident Type_1	Sexual Assault - 2C:14-2b
25-058331	7/13/2025	2:42:00 AM	null	null	7/13/2025	2:47:47 AM	Charles Street & , Hackensack, NJ, 07601	F1	null	"On 07/13/25, P.O. Almonte, P.O. Badalyan, and I responded to Charles Street on a report of a sexual assault complaint. Upon arrival, we met with the victim who reported her friend, Sthiven Rodriguez, sexually assaulted her by penetrating his penis into her vagina. The victim stated her and the suspect never had a dating relationship; however, have been friends for approximately 12 years. The victim stated her and the suspect was on their way back from 'Iron Bar' located in Morristown, NJ. The victim then stated the suspect had parked ""a couple blocks"" away from Charles Street in the city of Hackensack where the assault took place. The victim stated she refused multiple times to have any sexual contact with the suspect. The victim stated the suspect then disregarded then proceeded by penetrating his penis into her vagina. The victim then stated at this time she exited the vehicle and called the police. Lt. Dominguez arrived on scene to assist. The victim requested to be transported to police he..."	null	null	null	null	null	null	null	null	null	null	knapp_j	Complete	P.O. Juda DeOliveira 376	A4	Sgt. Patrick Williams 143	No Investigation	null	9	7/13/2025	2:42:00 AM	2:00:00 AM	Early Morning (00:00â€“03:59)	Street &, Unknown Block	Sexual Assault - 2C:14-2b	28-Day	Sexual Assault - 2C:14-2b	2:42:00 AM	7/13/2025	2:00:00 AM	null	Early Morning (00:00â€“03:59)	Sunday	July	2025	29	3	13	194	Street &, Unknown Block	Charles Street & , Hackensack, NJ, 07601	null	null	null	null	null	null	Early Morning (00:00â€“03:59)	Early Morning (00:00â€“03:59)	Incident Type_1	Sexual Assault - 2C:14-2b
25-059951	7/17/2025	11:01:06 PM	null	null	7/17/2025	11:02:06 PM	56 Pink Street, Hackensack, NJ, 07601	E2	5	On July 17, 2025, P.O. ````

Great! I found the issue. Looking at the "sex off.txt" file, I can see there are **13 sexual offense records** in your source data, but your Power BI is only showing **10**. Let me search for more details about data filtering issues:

**project_knowledge_search**

*Request*

````javascript
{
  "query": "removed duplicates filtering sexual offenses data loss ALL_CRIMES"
}
````

*Response*

````plaintext
Simplified All_Crimes M Code - No Filtering Issues.txt
? ""), Text.Upper(r[Incident_Type] ? ? ""))) in
            if Table.RowCount(matchedRow) > 0 then 
                matchedRow{0}[Category_Type]
            else 
                "Other", type text),

    // *** REMOVE EXISTING PERIOD COLUMN AND ADD NEW ONE ***
    #"Removed Old Period" = Table.RemoveColumns(#"Added Crime_Category", {"Period"}, MissingField.Ignore),
    #"Added Period" = Table.AddColumn(#"Removed Old Period", "Period", each
        let
            incidentDate = [INC_DATE]
        in
            // Handle null/missing dates and assign periods
            if incidentDate = null then "Unknown"
            else if incidentDate >= #date(2025, 7, 8) and incidentDate <= #date(2025, 7, 14) then "7-Day"
            else if incidentDate >= #date(2025, 6, 17) and incidentDate <= #date(2025, 7, 14) then "28-Day"
            else if incidentDate >= #date(2025, 1, 1) then "YTD"
            else "Historical", type text),
    
    // Filter for your 5 crime categories only 
    #"Filtered Rows" = Table.SelectRows(#"Added Period", each [Crime_Category] <> "Other"),
    
    // *** REMOVE DUPLICATES BY CASE NUMBER ***
    #"Removed Duplicates" = Table.Distinct(#"Filtered Rows", {"Case Number"})

in
    #"Removed Duplicates"
````

````plaintext
Simplified All_Crimes M Code - No Filtering Issues.txt
// ðŸ•’ 2025-07-15-15-00-00
// Time_SCRPA_Analysis/simplified_all_crimes_fix
// Author: R. A. Carucci
// Purpose: Simplified All_Crimes M Code to eliminate record filtering issues and ensure all data flows through

let
    Source = Folder.Files("C:\Users\carucci_r\OneDrive - City of Hackensack\05_EXPORTS\_RMS\SCRPA_RMS"),
    #"Filtered Hidden Files" = Table.SelectRows(Source, each [Attributes]?[Hidden]? <> true),
    #"Invoke Custom Function" = Table.AddColumn(#"Filtered Hidden Files", "Transform File", each #"Transform FileB1"([Content])),
    #"Renamed Columns" = Table.RenameColumns(#"Invoke Custom Function", {"Name", "Source.Name"}),
    #"Removed Other Columns" = Table.SelectColumns(#"Renamed Columns", {"Source.Name", "Transform File"}),
    
    // Get sample file for column names
    SampleFile = #"Filtered Hidden Files"{0}[Content],
    SampleColumns = Table.ColumnNames(#"Transform FileB1"(SampleFile)),
    #"Expanded Table Column" = Table.ExpandTableColumn(#"Removed Other Columns", "Transform File", SampleColumns),
    
    // Load Crime Category Reference Table
    CrimeReferenceTable = Csv.Document(File.Contents("C:\Users\carucci_r\OneDrive - City of Hackensack\Documents\Projects\T4_New\_Reference_Tables\CallTypeUpdatedWithCategories.csv"),[Delimiter=",", Columns=3, Encoding=65001, QuoteStyle=QuoteStyle.None]),
    #"Promoted Headers Ref" = Table.PromoteHeaders(CrimeReferenceTable, [PromoteAllScalars=true]),
    #"Clean Reference Headers" = Table.TransformColumnNames(#"Promoted Headers Ref", each Text.Trim(_)),
    #"Fixed Reference Column Names" = Table.RenameColumns(#"Clean Reference Headers", {{"Incident _Type", "Incident_Type"}}, MissingField.Ignore),

    // Fix column name mapping from Transform File to expected format
    #"Fixed Column Names" = Table.RenameColumns(#"Expanded Table Column", {
        {"CaseNumber", "Case Number"},
        {"IncidentTime", "Incident Time"},
        {"IncidentDateBetween", "Incident Date_Between"},
        {"IncidentTimeBetween", "Incident Time_Between"},
        {"ReportDate", "Report Date"},
        {"ReportTime", "Report Time"},
        {"IncidentType1", "Incident Type_1"},
        {"IncidentType2", "Incident Type_2"},
        {"IncidentType3", "Incident Type_3"},
        {"TotalValueStolen", "Total Value Stolen"},
````

````plaintext
Complete ALL_CRIMES M Code - Drop-in Ready.txt
? ""), Text.Upper(r[Incident_Type] ? ? ""))) in
            if Table.RowCount(matchedRow) > 0 then 
                matchedRow{0}[Category_Type]
            else 
                "Other", type text),

    // *** REMOVE EXISTING PERIOD COLUMN AND ADD NEW ONE ***
    #"Removed Old Period" = Table.RemoveColumns(#"Added Crime_Category", {"Period"}, MissingField.Ignore),
    #"Added Period" = Table.AddColumn(#"Removed Old Period", "Period", each
        let
            incidentDate = [INC_DATE]
        in
            // Handle null/missing dates and assign periods
            if incidentDate = null then "Unknown"
            else if incidentDate >= #date(2025, 7, 8) and incidentDate <= #date(2025, 7, 14) then "7-Day"
            else if incidentDate >= #date(2025, 6, 17) and incidentDate <= #date(2025, 7, 14) then "28-Day"
            else if incidentDate >= #date(2025, 1, 1) then "YTD"
            else "Historical", type text),
    
    // Filter for your 5 crime categories only 
    #"Filtered Rows" = Table.SelectRows(#"Added Period", each [Crime_Category] <> "Other"),
    
    // *** REMOVE DUPLICATES BY CASE NUMBER ***
    #"Removed Duplicates" = Table.Distinct(#"Filtered Rows", {"Case Number"})

in
    #"Removed Duplicates"
````

````plaintext
Complete ALL_CRIMES M Code - Drop-in Ready.txt
? ""), Text.Upper(r[Incident_Type] ? ? ""))) in
            if Table.RowCount(matchedRow) > 0 then 
                matchedRow{0}[Category_Type]
            else 
                "Other", type text),

    // *** REMOVE EXISTING PERIOD COLUMN AND ADD NEW ONE ***
    #"Removed Old Period" = Table.RemoveColumns(#"Added Crime_Category", {"Period"}, MissingField.Ignore),
    #"Added Period" = Table.AddColumn(#"Removed Old Period", "Period", each
        let
            incidentDate = [INC_DATE]
        in
            // Handle null/missing dates and assign periods
            if incidentDate = null then "Unknown"
            else if incidentDate >= #date(2025, 7, 8) and incidentDate <= #date(2025, 7, 14) then "7-Day"
            else if incidentDate >= #date(2025, 6, 17) and incidentDate <= #date(2025, 7, 14) then "28-Day"
            else if incidentDate >= #date(2025, 1, 1) then "YTD"
            else "Historical", type text),
    
    // Filter for your 5 crime categories only 
    #"Filtered Rows" = Table.SelectRows(#"Added Period", each [Crime_Category] <> "Other"),
    
    // *** REMOVE DUPLICATES BY CASE NUMBER ***
    #"Removed Duplicates" = Table.Distinct(#"Filtered Rows", {"Case Number"})

in
    #"Removed Duplicates"
````

````plaintext
Fixed All_Crimes M Code with Proper Period Logic.txt
? ""), Text.Upper(r[Incident_Type] ? ? "")))