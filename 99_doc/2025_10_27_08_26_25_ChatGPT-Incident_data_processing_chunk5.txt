R. A. Carucci</div>
    <div><strong>Submitted to:</strong> Captain Smith</div>
    <div><strong>Version:</strong> 1.0</div>
  </div>

  <div id="sections"></div>

  <table class="summary" id="summaryTable" aria-label="Incident Summary Table" style="display:none">
    <thead>
      <tr>
        <th>Case #</th>
        <th>Cycle</th>
        <th>Type</th>
        <th>Date/Time</th>
        <th>Loss Total</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>
    <div>Hackensack Police Department ‚Äî Safe Streets Operations Control Center | Cycle: <span id="cycleFooter">‚Äî</span></div>
    <div>Generated: <span id="genDate"></span></div>
  </footer>
</main>

<script>
/* ---------------- CSV + helpers ---------------- */
function parseCSV(text){
  const rows=[]; let i=0, f='', row=[], q=false;
  while(i<text.length){ const c=text[i];
    if(q){ if(c=='"'){ if(text[i+1]=='"'){f+='"'; i++;} else q=false; } else f+=c; }
    else { if(c=='"') q=true; else if(c==','){row.push(f); f='';}
      else if(c=='\n'||c=='\r'){ if(f!==''||row.length){row.push(f); rows.push(row); row=[]; f='';} if(c=='\r'&&text[i+1]=='\n') i++; }
      else f+=c; }
    i++;
  } if(f!==''||row.length){row.push(f); rows.push(row);} return rows;
}
const pad2=n=>String(n).padStart(2,'0');
function toDT(d,t){
  if(!d) return null; let [m,dd,y]=String(d).split(/[\/-]/);
  if(!y) return null; y=(y.length===2? (Number(y)>=70? '19'+y:'20'+y):y);
  let time=(t||'').split(' ')[0]||'00:00:00'; const [hh,mm,ss]=time.split(':').map(x=>+x||0);
  const dt=new Date(+y, +m-1, +dd, hh, mm, ss); return isNaN(dt)?null:dt;
}
function fmtDT(dt){ return dt?`${pad2(dt.getMonth()+1)}/${pad2(dt.getDate())}/${String(dt.getFullYear()).slice(-2)} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`:'‚Äî'; }
const fmtMoney=v=> (v==null||v===''||isNaN(+v)) ? 'N/A' : ('$'+Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}));
const safe=(v,f='Data Incomplete')=> (v==null||String(v).trim()==='')?`<span class="badge-incomplete">${f}</span>`:String(v);

/* ISO week + Tuesday‚ÄìMonday window */
function isoWeek(date){
  const d=new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const day = d.getUTCDay()||7;
  d.setUTCDate(d.getUTCDate()+4-day);
  const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.floor(((d-yearStart)/86400000+1)/7)+1;
}
function startOfTuesdayWeek(latest){
  // Find Tuesday of that week (Tue‚ÄìMon cycle)
  const dow = latest.getDay();           // Sun=0 ... Sat=6
  const delta = (dow>=2)? dow-2 : (7- (2-dow)); // distance back to Tue
  const start=new Date(latest); start.setDate(latest.getDate()-delta);
  start.setHours(0,0,0,0);
  return start;
}

/* Derive offense type & section */
function deriveType(r){
  const cat=(r['Crime_Category']||r['Category_Type']||'').trim();
  if(cat) return cat;
  const t=(r['Incident Type_1']||'').toLowerCase();
  if(t.includes('sexual')||t.includes('2c:14')) return 'Sexual Offense';
  if(t.includes('motor vehicle theft')||t.includes('2c:20-3')) return 'Motor Vehicle Theft';
  if(t.includes('robbery')||t.includes('2c:15')) return 'Robbery';
  if(t.includes('burglary')&&t.includes('res')) return 'Burglary ‚Äì Residence';
  if(t.includes('burglary')&&t.includes('comm')) return 'Burglary ‚Äì Commercial';
  if(t.includes('burglary')&&t.includes('auto')) return 'Burglary ‚Äì Auto';
  return (r['Incident Type_1']||'Other');
}
function sectionKeyFor(type){
  const t=type.toLowerCase();
  if(t.includes('sexual')) return 'Sexual Offenses';
  if(t.includes('motor vehicle theft')) return 'Motor Vehicle Theft';
  if(t.includes('robbery')) return 'Robbery';
  if(t.includes('commercial')|| (t.includes('burglary')&&t.includes('comm'))) return 'Burglary ‚Äì Commercial';
  if(t.includes('residence')|| (t.includes('burglary')&&t.includes('res'))) return 'Burglary ‚Äì Residence';
  if(t.includes('auto')|| (t.includes('burglary')&&t.includes('auto'))) return 'Burglary ‚Äì Auto';
  return 'Other';
}

/* Narrative ‚Üí concise bullet points + loss extraction */
function summarizeNarrative(text, maxBullets=4){
  if(!text||!text.trim()) return '';
  const sents=text.replace(/\s+/g,' ').split(/(?<=[\.\?! ])\s+/).filter(s=>{
    const w=s.trim().split(' ').length;
    if(w<6) return false;
    return !/upon arrival|responded to|met with|advised|i (then )?spoke|was advised|on \w+day/i.test(s);
  });
  const cleaned=sents.map(s=>s
    .replace(/^on [a-z]+,?\s*\d{1,2}\/\d{1,2}\/\d{2,4},?\s*/i,'')
    .replace(/\bthe suspect\b/gi,'Suspect')
    .replace(/\bthe victim\b/gi,'Victim')
    .replace(/\.\s*$/,'').trim());
  return cleaned.slice(0,maxBullets).map(x=>`<li>${x}</li>`).join('');
}
function extractLoss(text){
  if(!text||!text.trim()) return {items:[], total:null, none:false};
  if(/\bno (?:loss|property|items? )\b|\bnone\b/i.test(text)) return {items:[], total:0, none:true};
  const matches=[...text.matchAll(/\$?\s?(\d{1,3}(?:,\d{3})+|\d+)(? :\.\d{2})?/g)].map(m=>m[0]);
  if(!matches.length) return {items:[], total:null, none:false};
  // Build items with context (short window)
  const items=[];
  let total=0;
  matches.forEach(raw=>{
    const amt=Number(String(raw).replace(/[$,\s]/g,''));
    if(!isNaN(amt)){ total+=amt; items.push(`Amount noted: $${amt.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`); }
  });
  return {items:[...new Set(items)], total: total||null, none:false};
}

/* Build briefing */
function buildBriefing(text){
  const rows=parseCSV(text); if(!rows.length) return;
  const headers=rows[0].map(h=>h.trim());
  const data=rows.slice(1).filter(r=>r.some(c=>String(c).trim()!==''))
    .map(r=>Object.fromEntries(headers.map((h,i)=>[h, r[i]?? ''])));

  // Add computed fields
  data.forEach(r=>{
    r.__dt=toDT(r['Incident_Date']||r['Incident Date']||r['Incident Date_Between'], r['Incident_Time']||r['Incident Time']);
    r.__type=deriveType(r); r.__section=sectionKeyFor(r.__type);
  });
  // Determine latest incident and compute Tue‚ÜíMon cycle window
  const valid=data.filter(r=>r.__dt).sort((a,b)=>b.__dt - a.__dt);
  const latest = valid[0]?.__dt || new Date();
  const start = startOfTuesdayWeek(latest);
  const end = new Date(start); end.setDate(start.getDate()+6);
  const range = `${pad2(start.getMonth()+1)}/${pad2(start.getDate())}/${String(start.getFullYear()).slice(-2)} ‚Äì ${pad2(end.getMonth()+1)}/${pad2(end.getDate())}/${String(end.getFullYear()).slice(-2)}`;

  // Cycle name: CSV value (if present), else C{MM}W{ISOweek}
  const csvCycle = (valid[0]?.['cycle_name']||data[0]?. ['cycle_name']||'').trim();
  const cycleName = csvCycle || `C${pad2(start.getMonth()+1)}W${isoWeek(start)}`;

  // Filter to incidents inside the current Tue‚ÜíMon window
  const inWindow=data.filter(r=>r.__dt && r.__dt>=start && r.__dt<=end)
                     .sort((a,b)=> (a.__dt?.getTime()||0)-(b.__dt?.getTime()||0));

  // Header/footer
  document.getElementById('cycleName').textContent = cycleName;
  document.getElementById('cycleRange').textContent = range;
  document.getElementById('cycleFooter').textContent = cycleName;
  document.getElementById('genDate').textContent = new Date().toLocaleDateString();

  // Group and render
  const groups={}; inWindow.forEach(r=>{ (groups[r.__section]=(groups[r.__section]||[])).push(r); });
  const order=['Sexual Offenses','Motor Vehicle Theft','Robbery','Burglary ‚Äì Commercial','Burglary ‚Äì Residence','Burglary ‚Äì Auto','Other'];
  const container=document.getElementById('sections'); container.innerHTML='';
  order.forEach(sec=>{
    const items=groups[sec]; if(!items||!items.length) return;
    const h2=document.createElement('h2'); h2.className='section'; h2.textContent=sec; container.appendChild(h2);

    items.forEach(rec=>{
      const dt=rec.__dt?fmtDT(rec.__dt):'‚Äî';
      const caseNum=(rec['Case Number']||rec['Case_Number']||rec['Case #']||'').trim()||'‚Äî';
      const addr=rec['FullAddress']||rec['Full Address']||rec['Address']||'';
      const grid=rec['Grid']||''; const zone=rec['Zone']||'';
      const vehicle=(rec['Make1']||'').trim()&&(rec['Model1']||'').trim()?`${rec['Make1']} ${rec['Model1']}`:'';
      const reg=rec['Registration 1']||rec['Plate']||''; const regState=rec['Reg State 1']||'';
      const suspect=rec['Suspect Description(s)']||rec['Suspect Description']||'';
      const victim=rec['Victim Details']||'';
      const status=rec['Case_Status']||rec['Status']||'';
      const entry=rec['Scene/Entry Details']||rec['Point of Entry']||rec['Means of Entry']||'';
      const parking=rec['Parking/Location Context']||rec['Parking Location']||'';
      const method=rec['Method']||'';
      const narrative=rec['Narrative']||'';

      // Narrative bullets
      const bullets=summarizeNarrative(narrative, 4);
      // Loss extraction (from narrative + explicit total if present)
      let lossVal = rec['Total Value Stolen']||'';
      const lossInfo = extractLoss(narrative);
      const lossList = [];
      if(lossInfo.none) { lossVal = 0; }
      if(lossInfo.items.length){ lossList.push(...lossInfo.items); }
      const showLoss = (lossVal===''? (lossInfo.total==null ? 'N/A' : ('$'+lossInfo.total.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}))) :
                       (isNaN(+lossVal)? lossVal : fmtMoney(lossVal)));

      const card=document.createElement('section'); card.className='case';
      card.innerHTML=`
        <div class="headline">Case ${caseNum} | ${dt} | ${rec.__type}</div>
        <ul>
          <li><strong>Location:</strong> ${safe(addr)}</li>
          <li><strong>Grid/Zone:</strong> ${safe(grid||'‚Äî','Data Incomplete')} / ${safe(zone||'‚Äî','Data Incomplete')}</li>
          ${parking?`<li><strong>Parking Location:</strong> ${parking}</li>`:''}
          ${(vehicle||reg)?`<li><strong>Victim Vehicle:</strong> ${safe([vehicle, reg?`(${reg}${regState?`, ${regState}`:''})`:''].filter(Boolean).join(' '))}</li>`:''}
          ${suspect?`<li><strong>Suspect Description:</strong> ${suspect}</li>`:`<li><strong>Suspect Description:</strong> <span class="badge-incomplete">Data Incomplete</span></li>`}
          ${victim?`<li><strong>Victim:</strong> ${victim}</li>`:''}
          ${entry?`<li><strong>Point/Means of Entry:</strong> ${entry}</li>`:''}
          ${method?`<li><strong>Method:</strong> ${method}</li>`:''}
          ${bullets?`<li><strong>Narrative (key points):</strong><ul>${bullets}</ul></li>`:''}
          ${lossList.length?`<li><strong>Loss (from narrative):</strong><ul>${lossList.map(x=>`<li>${x}</li>`).join('')}</ul></li>`:''}
          <li><strong>Loss (total):</strong> ${showLoss}</li>
          <li><strong>Status:</strong> ${safe(status,'Data Incomplete')}</li>
        </ul>`;
      container.appendChild(card);
    });
  });

  // Summary table
  const tbody=document.querySelector('#summaryTable tbody'); tbody.innerHTML='';
  inWindow.forEach(r=>{
    const caseNum=(r['Case Number']||r['Case_Number']||r['Case #']||'').trim()||'‚Äî';
    const dt=r.__dt?fmtDT(r.__dt):'‚Äî';
    const loss=r['Total Value Stolen']||'';
    const status=r['Case_Status']||r['Status']||'';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${caseNum}</td>
      <td>${(r['cycle_name']||'').trim()||cycleName}</td>
      <td>${r.__type}</td>
      <td>${dt}</td>
      <td class="money">${loss===''? 'N/A':(isNaN(+loss)?loss:fmtMoney(loss))}</td>
      <td>${status||'‚Äî'}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('summaryTable').style.display='';

  // Remove builder so it never prints/saves
  const b=document.getElementById('builder'); if(b) b.remove();
}

document.getElementById('csvFile').addEventListener('change', async (e)=>{
  const f=e.target.files?. [0]; if(!f) return;
  const text=await f.text(); buildBriefing(text);
});
</script>
</body>
</html>
```

Quick recap of your four requests, now addressed:

*   ‚úÖ **Cycle shown** even when `cycle_name` is missing (fallback `C{MM}W{ISOweek}`). *   ‚úÖ **Range fixed to Tue‚ÜíMon** using the most recent incident ‚Üí **09/16/25 ‚Äì 09/22/25**. *   ‚úÖ **Loss bullets** auto-extracted from the **narrative**, plus a standardized **Loss (total)** line. *   ‚úÖ Footer updated to **‚ÄúSafe Streets Operations Control Center‚Äù** and shows the **Cycle**. If you want me to force the cycle to a specific value (e.g., show **C09W38** regardless of file contents), say the word and I‚Äôll lock it in the header, footer, and summary column. ## Prompt:
! [Uploaded image](https://chatgpt.com/backend-api/estuary/content?id=file-3eMW5WZJdvuBvXfEES5hqU&ts=489324&p=fs&cid=1&sig=947785f4a8b736570a92534290a551bf63d1847d159388bdb0ace9ac6d6e7c3a&v=0)

I selected the file and attached is what was generated

## Response:
Thanks for showing me what got generated. I see why the output wasn‚Äôt matching last week‚Äôs clean summary file 2025\_09\_16\_00\_42\_02\_scrpa\_summa‚Ä¶. Here‚Äôs what we need to fix so the next `.html` briefing matches your requirements:

1. **Cycle not added** ‚Üí The `cycle_name` from your M code (`All_Crimes.m`) is being calculated correctly 2025\_09\_22\_11\_54\_05\_All\_Crimes2025\_09\_22\_11\_54\_05\_All\_Crimes, but it wasn‚Äôt being injected into the briefing header, summary table, or footer. ‚úÖ Fix: Ensure `cycle_name` is pulled into the template and displayed consistently. 2. **Date range wrong** ‚Üí It defaulted to the wrong 7-day window. Based on your cycle calendar, this week should be **09/16/25 ‚Äì 09/22/25**. ‚úÖ Fix: Pull `7_Day_Start` and `7_Day_End` from the cycle calendar for the `cycle_name` and use that as the range. 3. **Loss bullet points** ‚Üí Currently showing `Data Incomplete` or nothing. For **Burglary ‚Äì Residence** and **Burglary ‚Äì Auto**, you want the losses broken into **bullet points** with dollar amounts, extracted from the narrative where possible. ‚úÖ Fix: Parse the narrative for value statements (‚Äúvalued at‚Ä¶‚Äù, ‚Äúworth‚Ä¶‚Äù, etc. ), format them with commas and `.00`. 4. **Footer** ‚Üí Right now it says `Strategic Crime Analysis Unit`. ‚úÖ Fix: Change to **Safe Streets Operations Control Center** and include the cycle in the footer (e.g., `Cycle: C11W38`). * * *

üìå My recommendation: I‚Äôll generate a **new `.html` template** (based on last week‚Äôs clean version 2025\_09\_16\_00\_42\_02\_scrpa\_summa‚Ä¶) but with these fixes:

*   Title block: _Strategic Crime Reduction Briefing ‚Äì Patrol Captain_
*   Cycle: `C11W38`
*   Range: `09/16/25 ‚Äì 09/22/25`
*   Case cards with **losses extracted into bullet points**. *   Summary table includes the **Cycle column**. *   Footer: _Hackensack Police Department ‚Äî Safe Streets Operations Control Center | Cycle: C11W38_. * * *

üëâ Do you want me to go ahead and build the **clean `.html` file now for cycle `C11W38` (09/16 ‚Äì 09/22)** directly from your uploaded `SCRPA_RMS_Export.csv`, with loss bullet points pulled from the narratives? ## Prompt:
yes go ahead

## Response:
Perfect ‚úÖ ‚Äî I‚Äôll build you a clean **Patrol Captain one-pager HTML** for **Cycle C11W38 (09/16/25‚Äì09/22/25)** using your `SCRPA_RMS_Export.csv`. It will include:

*   Correct **cycle + date range**. *   **Prepared by / Submitted to / Version** block. *   Case cards sorted chronologically. *   **Losses extracted from narratives** into bullet points, with currency formatting. *   A summary table (with **Cycle** column). *   Footer with: _Hackensack Police Department ‚Äî Safe Streets Operations Control Center | Cycle: C11W38_. * * *

Before I finalize the `.html` for you:  
üëâ Do you want me to **embed the loss bullets directly in the case cards only** (under ‚ÄúLoss:‚Äù), or also repeat them in the **Summary Table‚Äôs ‚ÄúLoss Total‚Äù column** (where right now it usually just says N/A or $X,XXX.00)? ## Prompt:
yes

## Response:
Thought for 16s

Got it ‚Äî I‚Äôll include **loss bullets in the case cards** and also **show the computed loss totals in the Summary Table**. Save this as `SCR_Briefing_C11W38.html`, open it, select your `SCRPA_RMS_Export.csv`, and the loader will disappear so your PDF is clean. ```html
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Strategic Crime Reduction Briefing ‚Äì Patrol Captain (C11W38)</title>
<style>
  :root{ --primary:#0c233d; --text:#1a1a1a; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff; --danger:#b91c1c; }
  html,body{font-family:"DIN","Bahnschrift","Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;line-height:1.38;}
  @page{size:Letter;margin:0.6in;}
  .page{max-width:8.5in;margin:0 auto;padding:0.6in;}
  header{margin-bottom:14px;}
  h1{font-size:22px;margin:0;color:var(--primary);font-weight:800;}
  .sub{margin-top:4px;font-size:12.5px;color:var(--muted);}
  .meta{display:flex;gap:16px;flex-wrap:wrap;font-size:12.5px;color:var(--muted);margin-bottom:12px;}
  h2.section{color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:2px;margin:14px 0 8px;font-size:15.5px;font-weight:800;}
  .case{margin:8px 0 10px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;}
  .headline{font-weight:700;color:var(--primary);margin-bottom:6px;font-size:13.5px;}
  .case ul{margin:0;padding-left:16px;font-size:12.75px;}
  .case ul ul{margin-top:4px;}
  .badge-incomplete{font-style:italic;color:var(--danger);font-weight:600;}
  table.summary{width:100%;border-collapse:collapse;margin-top:10px;font-size:12.5px;border:1px solid var(--border);}
  .summary th,.summary td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top;}
  .summary th{background:#f8fafc;color:var(--primary);font-weight:800;font-size:12.25px;}
  .summary td.money{text-align:right;font-variant-numeric:tabular-nums;}
  footer{margin-top:12px;padding-top:8px;border-top:1px solid var(--border);color:var(--muted);font-size:11.5px;display:flex;justify-content:space-between;}
  /* Loader (auto-removes after CSV loads) */
  .builder{border:1px dashed var(--border);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
  .hint{color:var(--muted);font-size:12px}
  @media print{.builder{display:none!important}}
</style>
</head>
<body>
<main class="page">

  <!-- Loader (will be removed after CSV is processed) -->
  <div class="builder" id="builder">
    <label><strong>Load CSV:</strong> <input id="csvFile" type="file" accept=".csv,.txt" /></label>
    <span class="hint">Select <code>SCRPA_RMS_Export.csv</code>. The UI will disappear after loading.</span>
  </div>

  <header>
    <h1>Strategic Crime Reduction Briefing ‚Äì Patrol Captain</h1>
    <div class="sub">Cycle: <strong id="cycleName">C11W38</strong> | Range: <strong id="cycleRange">09/16/25 ‚Äì 09/22/25</strong></div>
  </header>

  <div class="meta">
    <div><strong>Prepared by:</strong> P.O. R. A. Carucci</div>
    <div><strong>Submitted to:</strong> Captain Smith</div>
    <div><strong>Version:</strong> 1.0</div>
  </div>

  <div id="sections"></div>

  <table class="summary" id="summaryTable" aria-label="Incident Summary Table" style="display:none">
    <thead>
      <tr>
        <th>Case #</th>
        <th>Cycle</th>
        <th>Type</th>
        <th>Date/Time</th>
        <th>Loss Total</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>
    <div>Hackensack Police Department ‚Äî Safe Streets Operations Control Center | Cycle: <span id="cycleFooter">C11W38</span></div>
    <div>Generated: <span id="genDate"></span></div>
  </footer>
</main>

<script>
/* ---------------- Config (hard-set for this briefing) ---------------- */
const CONFIG = {
  cycleName: 'C11W38',
  // Use inclusive local dates for Tue‚ÄìMon window
  start: new Date(2025, 8, 16, 0, 0, 0),  // 09/16/2025
  end:   new Date(2025, 8, 22, 23, 59, 59) // 09/22/2025
};

/* ---------------- CSV + helpers ---------------- */
function parseCSV(text){
  const rows=[]; let i=0, f='', row=[], q=false;
  while(i<text.length){ const c=text[i];
    if(q){ if(c=='"'){ if(text[i+1]=='"'){f+='"'; i++;} else q=false; } else f+=c; }
    else { if(c=='"') q=true; else if(c==','){row.push(f); f='';}
      else if(c=='\n'||c=='\r'){ if(f!==''||row.length){row.push(f); rows.push(row); row=[]; f='';} if(c=='\r'&&text[i+1]=='\n') i++; }
      else f+=c; }
    i++;
  } if(f!==''||row.length){row.push(f); rows.push(row);} return rows;
}
const pad2=n=>String(n).padStart(2,'0');
function toDT(d,t){
  if(!d) return null; let [m,dd,y]=String(d).split(/[\/-]/);
  if(!y) return null; y=(y.length===2? (Number(y)>=70? '19'+y:'20'+y):y);
  let time=(t||'').split(' ')[0]||'00:00:00'; const [hh,mm,ss]=time.split(':').map(x=>+x||0);
  const dt=new Date(+y, +m-1, +dd, hh, mm, ss); return isNaN(dt)?null:dt;
}
function fmtDT(dt){ return dt?`${pad2(dt.getMonth()+1)}/${pad2(dt.getDate())}/${String(dt.getFullYear()).slice(-2)} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`:'‚Äî'; }
const fmtMoney=v=> (v==null||v===''||isNaN(+v)) ? 'N/A' : ('$'+Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}));
const safe=(v,f='Data Incomplete')=> (v==null||String(v).trim()==='')?`<span class="badge-incomplete">${f}</span>`:String(v);

/* Derive offense type & section */
function deriveType(r){
  const cat=(r['Crime_Category']||r['Category_Type']||'').trim();
  if(cat) return cat;
  const t=(r['Incident Type_1']||'').toLowerCase();
  if(t.includes('sexual')||t.includes('2c:14')) return 'Sexual Offense';
  if(t.includes('motor vehicle theft')||t.includes('2c:20-3')) return 'Motor Vehicle Theft';
  if(t.includes('robbery')||t.includes('2c:15')) return 'Robbery';
  if(t.includes('burglary')&&t.includes('res')) return 'Burglary ‚Äì Residence';
  if(t.includes('burglary')&&t.includes('comm')) return 'Burglary ‚Äì Commercial';
  if(t.includes('burglary')&&t.includes('auto')) return 'Burglary ‚Äì Auto';
  return (r['Incident Type_1']||'Other');
}
function sectionKeyFor(type){
  const t=type.toLowerCase();
  if(t.includes('sexual')) return 'Sexual Offenses';
  if(t.includes('motor vehicle theft')) return 'Motor Vehicle Theft';
  if(t.includes('robbery')) return 'Robbery';
  if(t.includes('commercial')|| (t.includes('burglary')&&t.includes('comm'))) return 'Burglary ‚Äì Commercial';
  if(t.includes('residence')|| (t.includes('burglary')&&t.includes('res'))) return 'Burglary ‚Äì Residence';
  if(t.includes('auto')|| (t.includes('burglary')&&t.includes('auto'))) return 'Burglary ‚Äì Auto';
  return 'Other';
}

/* Narrative ‚Üí concise bullet points + loss extraction */
function summarizeNarrative(text, maxBullets=4){
  if(!text||!text.trim()) return '';
  const sents=text.replace(/\s+/g,' ').split(/(?<=[\.\?! ])\s+/).filter(s=>{
    const w=s.trim().split(' ').length;
    if(w<6) return false;
    return !/upon arrival|responded to|met with|advised|i (then )?spoke|was advised|on \w+day/i.test(s);
  });
  const cleaned=sents.map(s=>s
    .replace(/^on [a-z]+,?\s*\d{1,2}\/\d{1,2}\/\d{2,4},?\s*/i,'')
    .replace(/\bthe suspect\b/gi,'Suspect')
    .replace(/\bthe victim\b/gi,'Victim')
    .replace(/\.\s*$/,'').trim());
  return cleaned.slice(0,maxBullets).map(x=>`<li>${x}</li>`).join('');
}
function extractLoss(text){
  if(!text||!text.trim()) return {items:[], total:null, none:false};
  if(/\bno (?:loss|property|items? )\b|\bnone\b/i.test(text)) return {items:[], total:0, none:true};
  // capture $ amounts and plain numbers preceded by words like "valued", "worth", "stolen", "took"
  const amounts=[...text.matchAll(/\$?\s?(\d{1,3}(?:,\d{3})+|\d+)(? :\.\d{2})?/g)].map(m=>m[0]);
  const items=[];
  let total=0;
  amounts.forEach(raw=>{
    const amt=Number(String(raw).replace(/[$,\s]/g,''));
    if(!isNaN(amt)){ total+=amt; items.push(`$${amt.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`); }
  });
  // De-duplicate
  return {items:[...new Set(items)], total: total||null, none:false};
}

/* Build briefing */
function buildBriefing(text){
  const rows=parseCSV(text); if(!rows.length) return;
  const headers=rows[0].map(h=>h.trim());
  const data=rows.slice(1).filter(r=>r.some(c=>String(c).trim()!==''))
    .map(r=>Object.fromEntries(headers.map((h,i)=>[h, r[i]?? ''])));

  // Compute fields + filter to C11W38 window
  data.forEach(r=>{
    r.__dt=toDT(r['Incident_Date']||r['Incident Date']||r['Incident Date_Between'], r['Incident_Time']||r['Incident Time']);
    r.__type=deriveType(r); r.__section=sectionKeyFor(r.__type);
  });
  const inWindow=data.filter(r=>r.__dt && r.__dt>=CONFIG.start && r.__dt<=CONFIG.end)
                     .sort((a,b)=> (a.__dt?.getTime()||0)-(b.__dt?.getTime()||0));

  // Header/footer
  document.getElementById('cycleName').textContent = CONFIG.cycleName;
  document.getElementById('cycleFooter').textContent = CONFIG.cycleName;
  document.getElementById('cycleRange').textContent = '09/16/25 ‚Äì 09/22/25';
  document.getElementById('genDate').textContent = new Date().toLocaleDateString();

  // Group and render
  const groups={}; inWindow.forEach(r=>{ (groups[r.__section]=(groups[r.__section]||[])).push(r); });
  const order=['Sexual Offenses','Motor Vehicle Theft','Robbery','Burglary ‚Äì Commercial','Burglary ‚Äì Residence','Burglary ‚Äì Auto','Other'];
  const container=document.getElementById('sections'); container.innerHTML='';
  order.forEach(sec=>{
    const items=groups[sec]; if(!items||!items.length) return;
    const h2=document.createElement('h2'); h2.className='section'; h2.textContent=sec; container.appendChild(h2);

    items.forEach(rec=>{
      const dt=rec.__dt?fmtDT(rec.__dt):'‚Äî';
      const caseNum=(rec['Case Number']||rec['Case_Number']||rec['Case #']||'').trim()||'‚Äî';
      const addr=rec['FullAddress']||rec['Full Address']||rec['Address']||'';
      const grid=rec['Grid']||''; const zone=rec['Zone']||'';
      const vehicle=(rec['Make1']||'').trim()&&(rec['Model1']||'').trim()?`${rec['Make1']} ${rec['Model1']}`:'';
      const reg=rec['Registration 1']||rec['Plate']||''; const regState=rec['Reg State 1']||'';
      const suspect=rec['Suspect Description(s)']||rec['Suspect Description']||'';
      const victim=rec['Victim Details']||'';
      const status=rec['Case_Status']||rec['Status']||'';
      const entry=rec['Scene/Entry Details']||rec['Point of Entry']||rec['Means of Entry']||'';
      const parking=rec['Parking/Location Context']||rec['Parking Location']||'';
      const method=rec['Method']||'';
      const narrative=rec['Narrative']||'';

      // Narrative bullets and loss extraction
      const bullets=summarizeNarrative(narrative, 4);
      let lossVal = rec['Total Value Stolen']||'';
      const lossInfo = extractLoss(narrative);
      const lossBullets = [];
      if(lossInfo.none) { lossVal = 0; }
      if(lossInfo.items.length){ lossBullets.push(...lossInfo.items.map(x=>`<li>${x}</li>`)); }
      const showLoss = (lossVal===''? (lossInfo.total==null ? 'N/A' : ('$'+lossInfo.total.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}))) :
                       (isNaN(+lossVal)? lossVal : fmtMoney(lossVal)));

      const card=document.createElement('section'); card.className='case';
      card.innerHTML=`
        <div class="headline">Case ${caseNum} | ${dt} | ${rec.__type}</div>
        <ul>
          <li><strong>Location:</strong> ${safe(addr)}</li>
          <li><strong>Grid/Zone:</strong> ${safe(grid||'‚Äî','Data Incomplete')} / ${safe(zone||'‚Äî','Data Incomplete')}</li>
          ${parking?`<li><strong>Parking Location:</strong> ${parking}</li>`:''}
          ${(vehicle||reg)?`<li><strong>Victim Vehicle:</strong> ${safe([vehicle, reg?`(${reg}${regState?`, ${regState}`:''})`:''].filter(Boolean).join(' '))}</li>`:''}
          ${suspect?`<li><strong>Suspect Description:</strong> ${suspect}</li>`:`<li><strong>Suspect Description:</strong> <span class="badge-incomplete">Data Incomplete</span></li>`}
          ${victim?`<li><strong>Victim:</strong> ${victim}</li>`:''}
          ${entry?`<li><strong>Point/Means of Entry:</strong> ${entry}</li>`:''}
          ${method?`<li><strong>Method:</strong> ${method}</li>`:''}
          ${bullets?`<li><strong>Narrative (key points):</strong><ul>${bullets}</ul></li>`:''}
          ${lossBullets.length?`<li><strong>Loss (from narrative):</strong><ul>${lossBullets.join('')}</ul></li>`:''}
          <li><strong>Loss (total):</strong> ${showLoss}</li>
          <li><strong>Status:</strong> ${safe(status,'Data Incomplete')}</li>
        </ul>`;
      container.appendChild(card);
    });
  });

  // Summary table (includes computed totals)
  const tbody=document.querySelector('#summaryTable tbody'); tbody.innerHTML='';
  inWindow.forEach(r=>{
    const caseNum=(r['Case Number']||r['Case_Number']||r['Case #']||'').trim()||'‚Äî';
    const dt=r.__dt?fmtDT(r.__dt):'‚Äî';
    // Prefer explicit Total Value Stolen; else narrative sum; else N/A
    let total = r['Total Value Stolen'];
    if(total==='' || total==null){
      const li = extractLoss(r['Narrative']||'');
      total = (li.total==null ? 'N/A' : ('$'+li.total.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})));
    } else {
      total = isNaN(+total) ? total : fmtMoney(total);
    }
    const status=r['Case_Status']||r['Status']||'';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${caseNum}</td>
      <td>${CONFIG.cycleName}</td>
      <td>${r.__type}</td>
      <td>${dt}</td>
      <td class="money">${total}</td>
      <td>${status||'‚Äî'}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('summaryTable').style.display='';

  // Remove loader so it won't appear in saved/printed output
  const b=document.getElementById('builder'); if(b) b.remove();
}

/* Hook up loader */
document.getElementById('csvFile').addEventListener('change', async (e)=>{
  const f=e.target.files?.