<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Enterprise Chunker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-cogs"></i> Enterprise Chunker
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/upload"><i class="fas fa-upload"></i> Upload</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/files"><i class="fas fa-folder"></i> Files</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics"><i class="fas fa-chart-bar"></i> Analytics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/settings"><i class="fas fa-cog"></i> Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-cog"></i> System Settings</h4>
                    </div>
                    <div class="card-body">
                        <form id="settings-form">
                            <!-- File Processing Settings -->
                            <div class="mb-4">
                                <h5><i class="fas fa-file-alt"></i> File Processing</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="chunk-size" class="form-label">Chunk Size</label>
                                            <input type="number" class="form-control" id="chunk-size" min="50" max="2000" value="800">
                                            <div class="form-text">Number of characters per chunk (50-2000)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="overlap" class="form-label">Overlap</label>
                                            <input type="number" class="form-control" id="overlap" min="0" max="200" value="50">
                                            <div class="form-text">Overlap between chunks (0-200)</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="min-chunk" class="form-label">Minimum Chunk Size</label>
                                            <input type="number" class="form-control" id="min-chunk" min="10" max="500" value="100">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max-chunk" class="form-label">Maximum Chunk Size</label>
                                            <input type="number" class="form-control" id="max-chunk" min="100" max="3000" value="1500">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Filter Settings -->
                            <div class="mb-4">
                                <h5><i class="fas fa-filter"></i> File Filtering</h5>
                                <div class="mb-3">
                                    <label for="filter-mode" class="form-label">Filter Mode</label>
                                    <select class="form-select" id="filter-mode">
                                        <option value="all">All Files</option>
                                        <option value="patterns">Pattern Matching</option>
                                        <option value="suffix">Suffix Matching</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="file-patterns" class="form-label">File Patterns</label>
                                    <input type="text" class="form-control" id="file-patterns" value="_full_conversation,_conversation,_chat">
                                    <div class="form-text">Comma-separated patterns to match</div>
                                </div>
                                <div class="mb-3">
                                    <label for="exclude-patterns" class="form-label">Exclude Patterns</label>
                                    <input type="text" class="form-control" id="exclude-patterns" value="_draft,_temp,_backup">
                                    <div class="form-text">Comma-separated patterns to exclude</div>
                                </div>
                            </div>

                            <!-- Performance Settings -->
                            <div class="mb-4">
                                <h5><i class="fas fa-tachometer-alt"></i> Performance</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parallel-workers" class="form-label">Parallel Workers</label>
                                            <input type="number" class="form-control" id="parallel-workers" min="1" max="8" value="4">
                                            <div class="form-text">Number of parallel processing workers</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="polling-interval" class="form-label">Polling Interval (seconds)</label>
                                            <input type="number" class="form-control" id="polling-interval" min="1" max="60" value="5">
                                            <div class="form-text">How often to check for new files</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Directory Settings -->
                            <div class="mb-4">
                                <h5><i class="fas fa-folder"></i> Directories</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="watch-folder" class="form-label">Watch Folder</label>
                                            <input type="text" class="form-control" id="watch-folder" value="C:/_chunker/02_data">
                                            <div class="form-text">Folder to monitor for new files</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="output-dir" class="form-label">Output Directory</label>
                                            <input type="text" class="form-control" id="output-dir" value="C:/_chunker/04_output">
                                            <div class="form-text">Folder for processed chunks and transcripts</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="archive-dir" class="form-label">Archive Directory</label>
                                    <input type="text" class="form-control" id="archive-dir" value="C:/_chunker/03_archive">
                                    <div class="form-text">Folder for archived original files</div>
                                </div>
                            </div>

                            <!-- Notification Settings -->
                            <div class="mb-4">
                                <h5><i class="fas fa-bell"></i> Notifications</h5>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="notifications-enabled">
                                    <label class="form-check-label" for="notifications-enabled">
                                        Enable Email Notifications
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label for="admin-emails" class="form-label">Admin Email Addresses</label>
                                    <input type="text" class="form-control" id="admin-emails" value="admin@example.com">
                                    <div class="form-text">Comma-separated email addresses</div>
                                </div>
                            </div>

                            <!-- System Settings -->
                            <div class="mb-4">
                                <h5><i class="fas fa-server"></i> System</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="log-level" class="form-label">Log Level</label>
                                            <select class="form-select" id="log-level">
                                                <option value="DEBUG">Debug</option>
                                                <option value="INFO" selected>Info</option>
                                                <option value="WARNING">Warning</option>
                                                <option value="ERROR">Error</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max-log-size" class="form-label">Max Log Size (MB)</label>
                                            <input type="number" class="form-control" id="max-log-size" min="1" max="100" value="5">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="log-rotation" checked>
                                    <label class="form-check-label" for="log-rotation">
                                        Enable Log Rotation
                                    </label>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="settingsManager.resetToDefaults()">
                                    <i class="fas fa-undo"></i> Reset to Defaults
                                </button>
                                <div>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="settingsManager.testSettings()">
                                        <i class="fas fa-vial"></i> Test Settings
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class SettingsManager {
            constructor() {
                this.init();
            }

            init() {
                this.loadSettings();
                this.bindEvents();
            }

            bindEvents() {
                const form = document.getElementById('settings-form');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSettings();
                });
            }

            async loadSettings() {
                try {
                    const response = await fetch('/api/settings');
                    const settings = await response.json();
                    
                    if (settings.success) {
                        this.populateForm(settings.config);
                    } else {
                        this.showNotification('Failed to load settings', 'danger');
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                    this.showNotification('Failed to load settings: ' + error.message, 'danger');
                }
            }

            populateForm(config) {
                // File Processing
                document.getElementById('chunk-size').value = config.chunk_size || 800;
                document.getElementById('overlap').value = config.overlap || 50;
                document.getElementById('min-chunk').value = config.min_chunk_size || 100;
                document.getElementById('max-chunk').value = config.max_chunk_size || 1500;

                // File Filtering
                document.getElementById('filter-mode').value = config.file_filter_mode || 'all';
                document.getElementById('file-patterns').value = config.file_patterns ? config.file_patterns.join(',') : '';
                document.getElementById('exclude-patterns').value = config.exclude_patterns ? config.exclude_patterns.join(',') : '';

                // Performance
                document.getElementById('parallel-workers').value = config.parallel_workers || 4;
                document.getElementById('polling-interval').value = config.polling_interval || 5;

                // Directories
                document.getElementById('watch-folder').value = config.watch_folder || '';
                document.getElementById('output-dir').value = config.output_dir || '';
                document.getElementById('archive-dir').value = config.archive_dir || '';

                // Notifications
                document.getElementById('notifications-enabled').checked = config.notification_enabled || false;
                document.getElementById('admin-emails').value = config.admin_emails ? config.admin_emails.join(',') : '';

                // System
                document.getElementById('log-level').value = config.log_level || 'INFO';
                document.getElementById('max-log-size').value = config.max_log_size || 5;
                document.getElementById('log-rotation').checked = config.log_rotation !== false;
            }

            async saveSettings() {
                const config = this.collectFormData();
                
                try {
                    const response = await fetch('/api/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification('Settings saved successfully!', 'success');
                    } else {
                        this.showNotification('Failed to save settings: ' + result.error, 'danger');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showNotification('Failed to save settings: ' + error.message, 'danger');
                }
            }

            collectFormData() {
                return {
                    // File Processing
                    chunk_size: parseInt(document.getElementById('chunk-size').value),
                    overlap: parseInt(document.getElementById('overlap').value),
                    min_chunk_size: parseInt(document.getElementById('min-chunk').value),
                    max_chunk_size: parseInt(document.getElementById('max-chunk').value),

                    // File Filtering
                    file_filter_mode: document.getElementById('filter-mode').value,
                    file_patterns: document.getElementById('file-patterns').value.split(',').map(s => s.trim()).filter(s => s),
                    exclude_patterns: document.getElementById('exclude-patterns').value.split(',').map(s => s.trim()).filter(s => s),

                    // Performance
                    parallel_workers: parseInt(document.getElementById('parallel-workers').value),
                    polling_interval: parseInt(document.getElementById('polling-interval').value),

                    // Directories
                    watch_folder: document.getElementById('watch-folder').value,
                    output_dir: document.getElementById('output-dir').value,
                    archive_dir: document.getElementById('archive-dir').value,

                    // Notifications
                    notification_enabled: document.getElementById('notifications-enabled').checked,
                    admin_emails: document.getElementById('admin-emails').value.split(',').map(s => s.trim()).filter(s => s),

                    // System
                    log_level: document.getElementById('log-level').value,
                    max_log_size: parseInt(document.getElementById('max-log-size').value),
                    log_rotation: document.getElementById('log-rotation').checked
                };
            }

            async testSettings() {
                const config = this.collectFormData();
                
                try {
                    const response = await fetch('/api/settings/test', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification('Settings test passed!', 'success');
                    } else {
                        this.showNotification('Settings test failed: ' + result.error, 'danger');
                    }
                } catch (error) {
                    console.error('Error testing settings:', error);
                    this.showNotification('Failed to test settings: ' + error.message, 'danger');
                }
            }

            resetToDefaults() {
                if (confirm('Are you sure you want to reset all settings to defaults?')) {
                    this.populateForm({
                        chunk_size: 800,
                        overlap: 50,
                        min_chunk_size: 100,
                        max_chunk_size: 1500,
                        file_filter_mode: 'all',
                        file_patterns: ['_full_conversation', '_conversation', '_chat'],
                        exclude_patterns: ['_draft', '_temp', '_backup'],
                        parallel_workers: 4,
                        polling_interval: 5,
                        watch_folder: 'C:/_chunker/02_data',
                        output_dir: 'C:/_chunker/04_output',
                        archive_dir: 'C:/_chunker/03_archive',
                        notification_enabled: false,
                        admin_emails: ['admin@example.com'],
                        log_level: 'INFO',
                        max_log_size: 5,
                        log_rotation: true
                    });
                    this.showNotification('Settings reset to defaults', 'info');
                }
            }

            showNotification(message, type = 'info') {
                // Create toast notification
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-white bg-${type} border-0`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;

                // Add to toast container
                let container = document.querySelector('.toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'toast-container position-fixed top-0 end-0 p-3';
                    document.body.appendChild(container);
                }
                
                container.appendChild(toast);
                
                // Show toast
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                
                // Remove after hidden
                toast.addEventListener('hidden.bs.toast', () => {
                    toast.remove();
                });
            }
        }

        // Initialize settings manager
        let settingsManager;
        document.addEventListener('DOMContentLoaded', () => {
            settingsManager = new SettingsManager();
        });
    </script>
</body>
</html>
